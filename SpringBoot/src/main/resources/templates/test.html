<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:inline="javascript">
<head>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>Insert title here</title>
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
  <link rel="stylesheet" type="text/css" href="css/test.css">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
  <script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

</head>
<body>
	<input type="hidden" id="liIdx" th:value="${liIdx}" />
	<input type="hidden" id="liName" th:value="${liName}" />
	<input type="hidden" id="liTime" th:value="${liTime}" />
	<input type="hidden" id="liTimeSec" th:value="${liTimeSec}" />
	<input type="hidden" id="liPbc" th:value="${liPbc}" />
	<input type="hidden" id="name" th:value="${member.name}" />
	<input type="hidden" id="userId" th:value="${member.id}" />
    <input type="hidden" name="liChap1" th:value="${liChap1}" />
    <input type="hidden" name="liChap2" th:value="${liChap2}" />
    <input type="hidden" name="liChap3" th:value="${liChap3}" />
    <input type="hidden" name="liChap4" th:value="${lliChap4}" />
    <input type="hidden" name="liChap5" th:value="${liChap5}" />
    <input type="hidden" name="liChap6" th:value="${liChap6}" />
    
    <div id="loadingOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
		background-color:rgba(0,0,0,0.5); z-index:9999; color:white; font-size:24px; text-align:center; padding-top:20%;">
		ì±„ì  ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.
    </div>
    
    
	<div class="container">
      <div class="panel panel-warning">
         <!-- <div class="panel-heading">examPage -->
         <div class='header-block'>
         		<div class='test-nm-block'>
         			<!-- ìê²©ì¦ ì¸ë±ìŠ¤, ìê²©ì¦ ì´ë¦„ -->
         		    <label id="sheetNum" class="sheetNum" th:text="${liIdx}"></label>
         			<label class="test-info-testNm" th:text="${liName}"></label>
         			
         			<label style="position: absolute; right: 70px; bottom: 23px;"><button onclick="lotto()">ìˆ˜í—˜ë²ˆí˜¸ ë½‘ê¸°</button></label>
         			<label style="position: absolute; right: 70px; bottom: -5px;"><button onclick="lottoName()">ìˆ˜í—˜ì´ë¦„ ë½‘ê¸°</button></label>
         		</div>
         		<div class='user-info-block'>
         			<div class="user-id-block">
         				<span class="user-info-userId-label">ìˆ˜í—˜ë²ˆí˜¸ : </span>
         				<input id='lotto' class="user-info-userId" readonly="true" onfocus="this.blur()" style="cursor:default;" value="7777">
         			</div>
         			<div class="user-nm-block">
         				<span class="user-info-userNm-label">ìˆ˜í—˜ìëª… : </span>
         				<input id='lottoName' class="user-info-userNm" readonly="true" onfocus="this.blur()" style="cursor:default;" th:value="${member.name}">
         			</div>
         		</div>
				<div id ='timerImage' class='test-timer-block' style="background-image:url(&quot;https://www.q-net.or.kr/cbt/viewer/images/clock_icon.gif&quot;) !important">
					<div class='max-time-block'>
						<label class='label-max-time'>ì œí•œ ì‹œê°„ : 
							<label class='test-max-time-control' th:text="${liTime}"></label>
						</label>
					</div>
					<div class='left-time-block'>
						<label class='label-left-time'>ë‚¨ì€ ì‹œê°„: </label>
						<input class='test-left-time-control saningong_timer panel_saningong_timer' readonly='true'  onfocus='this.blur()' style='cursor:default;' ctrl='saningong_timer' >
						<input class='left-time-hidden' style='display:none;'>
					</div>
	         </div>
         </div>
         <div class="panel-body">
            <div class='text-box'>
            	<div class='section-tool-block'>
		            <div class='screen-tool'>
		         		<!-- 100% 150% 200% ë°°ì¹˜ ã…¡ : í•œì¤„ë¡œ ë³´ê¸° ã…£ : ë‘ì¤„ë¡œ ë³´ê¸° ã… : í•œë¬¸ì œ ë³´ê¸° -->
		         		<div class='zoom-tool'>
		         			<span class='zoom-tool-title'>ê¸€ìí¬ê¸°</span>
			         		<button id="zoom14" class='zoomBtn' onclick="magnification(14)" style='background: url(/images/100.gif) no-repeat;'></button>
			         		<button id="zoom20" class='zoomBtn' onclick="magnification(20)" style='background: url(/images/150.gif) no-repeat;'></button>
			         		<button id="zoom25" class='zoomBtn' onclick="magnification(25)" style='background: url(/images/200.gif) no-repeat;'></button>
			         	</div>
			         	<div class='layout-tool'>
			         		<span class='layout-tool-title'>í™”ë©´ë°°ì¹˜</span>
							<button id="oneLine" onclick="arrangement('oneLine')" class='layoutBtn' style='background: url(/images/one.gif) no-repeat;'></button>
							<button id="twoLine" onclick="arrangement('twoLine')" class='layoutBtn' style='background: url(/images/two.gif) no-repeat;'></button>
			         	</div>
		         	</div>
		         	<div class='section-name-block'></div>
		         	
		         	<div class='progress-info-block'>
		         		<div class="total-count-block">ì „ì²´ ë¬¸ì œ ìˆ˜&nbsp;&nbsp;: 
			         		<span class="count-info-total"  th:text="${liPbc}" ></span>
		         		</div>
		         		<div class="unsolved-count-block">ì•ˆ í‘¼ ë¬¸ì œ ìˆ˜ : 
			         		<span id="solCount" class="count-info-unsolved"  th:text="${liPbc}"></span>
		         		</div>
		         	</div>
		         	
         		</div>
				  <!-- ë¬¸ì œ ì¶œë ¥ ì˜ì—­ -->
				  <input type="hidden" id="category" th:value="${category}" />
				  <div id="print" class='test-page-block-holder'></div>
				  
				 <div class="scoreBackground" >
					<div id="scoreBox" class="scoreBox">
					
					  <!-- ìƒë‹¨ ì•ˆë‚´ -->
					  <div class="scoreComment" style="display: flex; align-items: center; margin-top: 50px;">
					    <img src="images/icon_title_megaphone.gif" style="width: 24px; height: 24px; vertical-align: middle;">
					    <span id="comment" style="margin-left: 10px;"></span>
					  </div>
					
					  <!-- í•˜ë‹¨ ì°¸ê³  ë¬¸êµ¬ -->
					  <div style="margin-bottom: 20px;">
					    <p style="margin: 0;">â€» ì§€ì—­ë³„, ì¢…ëª©ë³„ë¡œ ìƒì´í•˜ë¯€ë¡œ íë„·(http://www.q-net.or.kr) ì‹œí—˜ì¼ì • ì•ˆë‚´ë¥¼ ì°¸ê³ í•˜ì‹œê¸°</p>
					  </div>
					
					  <!-- ì ìˆ˜ í‘œ -->
					  <div class="scoreText">
					    <div>ìˆ˜í—˜ì ì´ë¦„</div>
					    <div>ì‘ì‹œ ì¢…ëª©</div>
					    <div>ì ìˆ˜</div>
					    <div>í•©ê²© ì—¬ë¶€</div>
					  </div>
					  <div class="scoreValue">
					    <div th:text="${member.name}"></div>
					    <div th:text="${liName}"></div>
					    <div id="score"></div>
					    <div id="pass"></div>
					  </div>
					  <br>
					  
					  <!-- ê³¼ëª©ì ìˆ˜ -->
					  <div class="scoreText">
					  	<div th:text="${liChap1}"></div>
					  	<div th:text="${liChap2}"></div>
					  	<div th:text="${liChap3}"></div>
					  	<div th:text="${liChap4}"></div>
					  	<div th:text="${liChap5}"></div>	
						<div th:text="${liChap6}" th:attr="style=${liChap6 == null} ? 'display:none;' : ''"></div>		  
					  </div>
					  <div class="scoreValue">
					  	<div id="liChap1"></div>
					  	<div id="liChap2"></div>
					  	<div id="liChap3"></div>
					  	<div id="liChap4"></div>
					  	<div id="liChap5"></div>
					  	<div id="liChap6" th:attr="style=${liChap6 == null} ? 'display:none;' : ''"></div>			  
					  </div>
					
					  <!-- ì•ˆë‚´ ë¬¸êµ¬ -->
					  <div style="margin-top: 20px; text-align: center;">
					    "ë“ì  ë° í•©ê²©ì—¬ë¶€ë¥¼ í™•ì¸í•˜ì…¨ìŠµë‹ˆê¹Œ?"
					  </div>
					
					  <!-- ë²„íŠ¼ -->
					  <div style="margin-top: 10px; text-align: center;">
					    <button type="button" onclick="goToLicense()">í™•ì¸ ì™„ë£Œ</button>
					  </div>
					
					</div>
				</div>
			</div>
				  <!-- ë‹µì•ˆ í‘œê¸°ë€ -->
				  <div id="number" class="number-box"></div>
         </div>
         <div class="footer-block">
         		<div class="footer-left-block">					
         			<button id="btnCaculator" >
	         			 <img src="/images/cal.gif" class="calculator_icon">
	         			 <span class="calculator_label">ê³„ì‚°ê¸°</span>
         			 </button>
         			 <div id="volumeIcon" class="button_volume_on" style="display:none;"></div>
         			<div id="volumeSlider"></div>
         		</div>
         		<div class="footer-center-block">
         		    <button id="prev-page" class="prev-page" onclick="prevPage()">â—€ ì´ì „</button>
         		   	<label id="pageIndex" class="page-position-label">1/3</label>
         		   	<button id="next-page" class="next-page" onclick="nextPage()">ë‹¤ìŒ â–¶</button>
         		 </div>
         		 <div class="footer-right-block">
         		 	<button id="btnUnsolved" onclick="unsolved()">
         		 		<img src="/images/unsolved_icon.gif" class="unsolved_icon">
         		 		<span class="unsolved_label">ì•ˆ í‘¼ ë¬¸ì œ</span></button>
         		 	<button id="btnLabel" type="button" onclick="examSubmit()">
         		 		<img src="/images/submit_icon.gif" class="submit_icon">
         		 		<span class="submit_label">ë‹µì•ˆ ì œì¶œ</span></button>
         		  </div>
         	</div>
      </div>
   </div>
   
   <!-- ë ˆì´ì–´ íŒì—… -->
<div id="unsolvedPopup" style="display:none; position:fixed; top:100px; left:50%; transform:translateX(-50%);
     background: white no-repeat 2px 4px; border:3px solid #3664b1; border-radius:4px; z-index:9999; width:400px; box-shadow:0 0 10px rgba(0,0,0,0.3);">

  <div style="background: #eefbfa; padding:8px; display:flex; justify-content:space-between; align-items:center;">
    <span style="color:#2a68af; font-weight:bold;"><img src= "/images/ico_what.gif"> ì•ˆ í‘¼ ë¬¸ì œ ë²ˆí˜¸ ë³´ê¸°: <span style="font-weight:bold;">ë²ˆí˜¸ í´ë¦­ì‹œ í•´ë‹¹ ë¬¸ì œë¡œ ì´ë™í•©ë‹ˆë‹¤.</span></span>
    <button onclick="hideUnsolvedPopup()" style="border:none; background:none; font-size:16px;">âœ•</button>
  </div>

  <div id="unsolvedList" style="padding:12px; display:flex; flex-wrap:wrap; gap:6px;"></div>
</div>

   
   <script type="text/javascript">
   let currentPage = 0;    // í˜„ì¬ í˜ì´ì§€ (0ë¶€í„° ì‹œì‘)
   let score = 0; // ì ìˆ˜
   const PageExam = []; // í•œ í˜ì´ì§€ë‹¹ 10ê°œì”© ë‹´ê¸´ ë¬¸ì œë¦¬ìŠ¤íŠ¸
   const pageExamNum = 10; // í•œí˜ì´ì§€ë‹¹ 10ë¬¸ì œ(ê³ ì •)
   const userSelections = {}; // ìœ ì €ê°€ ì„ íƒí•œ ë²ˆí˜¸ ì €ì¥
   const solvedStatus = {}; // ë¬¸ì œ ë²ˆí˜¸ -> 0 or 1
   const PbsData = [];  // ì„œë²„ë¡œ ë³´ë‚¼ ì±„ì  ë°ì´í„°
   const pbNum = []; // ë¬¸ì œ ë²ˆí˜¸
   const pbAns = []; // ì •ë‹µ ë°ì´í„°
   const pbIdx = []; // ë¬¸ì œ ì¸ë±ìŠ¤
   const category = $("#category").val(); // ì¹´í…Œê³ ë¦¬ ê°’( íšŒì°¨)
   const token = $("meta[name='_csrf']").attr("content");
   const header = $("meta[name='_csrf_header']").attr("content");
   const circledNumbers = ["â‘ ", "â‘¡", "â‘¢", "â‘£"]; // ë¬¸ì œ ë²ˆí˜¸ : ì„ íƒ ì„ ì§€ í…ìŠ¤íŠ¸
   const liIdx = $("#liIdx").val(); // liIdxê°’
   const userId = $("#userId").val(); // ìœ ì € Id

   
   
	$(document).ready(function(){
		// ready() : html ì½”ë“œê°€ ì¤€ë¹„ê°€ ë˜ë©´ ì‹¤í–‰ë˜ëŠ” ë©”ì†Œë“œ
		// ê²Œì‹œê¸€ì„ ëª¨ë‘ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë©”ì†Œë“œ!
		loadExam();
		Number();
	});
	
	document.addEventListener("DOMContentLoaded", function () {
		  const sec = parseInt(document.getElementById("liTimeSec").value, 10);
		  if (!isNaN(sec)) {
		    timer(sec);
		  }
		});
	
	function timer(sec) {
		  const input = document.querySelector('.saningong_timer');
		  const update = () => {
		    if (sec < 0) return;
		    const h = String(Math.floor(sec / 3600));
		    const m = String(Math.floor((sec % 3600) / 60)).padStart(2, '0');
		    const s = String(sec % 60).padStart(2, '0');
		    input.value = `${h}ì‹œ ${m}ë¶„ ${s}ì´ˆ`;
		    sec--;
		  };
		  update();
		  setInterval(update, 1000);
		}
	
	// ë¬¸ì œ ë°°ìœ¨
	function magnification(value) {
		$("#print").css("font-size",value);
		if(value=="14"){
		$("#zoom14").css("background","url(/images/100-click.gif) no-repeat");
		$("#zoom20").css("background","url(/images/150.gif) no-repeat");
		$("#zoom25").css("background","url(/images/200.gif) no-repeat");
		}if(value=="20"){
		$("#zoom"+value).css("background","url(/images/150-click.gif) no-repeat");
		$("#zoom14").css("background","url(/images/100.gif) no-repeat");
		$("#zoom25").css("background","url(/images/200.gif) no-repeat");
		}if(value=="25"){
		$("#zoom"+value).css("background","url(/images/200-click.gif) no-repeat");
		$("#zoom14").css("background","url(/images/100.gif) no-repeat");
		$("#zoom20").css("background","url(/images/150.gif) no-repeat");
		}
	}
	
	// ë¬¸ì œ ë°°ì¹˜
	function arrangement(value) {
		if(value === "oneLine"){	
		    $("#print").css({
		    	"display": "block"
		    });
		    $("#oneLine").css("background","url(/images/one-click.gif) no-repeat");
		    $("#twoLine").css("background","url(/images/two.gif) no-repeat");
		}else if(value === "twoLine"){	
		    $("#print").css({
		        "display": "flex",
		        "flex-wrap" : "wrap",
		        "width": "100%",
		        "align-items": "flex-start"
		    });
		    $("#oneLine").css("background","url(/images/one.gif) no-repeat");
		    $("#twoLine").css("background","url(/images/two-click.gif) no-repeat");
		}
/* 		else if(value === "singleQuestion"){	
			$("#print").css("column-count",1);
		} */
	}
	
	// ì˜¤ë¥¸ìª½ 1~100ê¹Œì§€ ìˆ«ì
	function Number() {
		
		let num = "";
		
		num += "<div style='text-align:center; color: #fff; background: url(/images/answer.gif) #6689C5; height: 47px; line-height: 46px; font-size: 1.6em; font-weight: bold; border-bottom: 1px solid #fff;'>ë‹µì•ˆí‘œê¸°ë€</div>";

		// 100ë¬¸ì œ forë¬¸
		for (let i = 1; i <= 100; i++) {
		  num += "<div style='height: 42.85px;'>";
		  num += "<label onclick='goNum("+ i +")' class='rightNum'>" + i + "</label>";
		  num += "<span class='rightChoice'>";
		  
		  for (let j = 1; j<= 4;  j++) {
		    num += "<img id='number" + i + "-" + j + "' src='/images/n" + j + ".jpg' style='padding: 3px;' onclick='selectChoice("+i+","+j+")'>";
		  }
		
		  num += "</span>";
		  num += "</div>";
		}
		
		$("#number").html(num);
	}
	

 	// ë²ˆí˜¸ì´ë™
function goNum(i) {
  const page = Math.floor((i - 1) / pageExamNum); // ëª‡ ë²ˆì§¸ í˜ì´ì§€ì¸ì§€ ê³„ì‚°

  // í˜„ì¬ í˜ì´ì§€ì™€ ë‹¤ë¥´ë©´ ë¨¼ì € í˜ì´ì§€ ë³€ê²½
  if (page !== currentPage) {
	 renderPage(page);  // í˜ì´ì§€ ë¡œë“œ í›„ ìŠ¤í¬ë¡¤í•˜ë ¤ë©´ ì•½ê°„ì˜ ë”œë ˆì´ í•„ìš”

    setTimeout(() => {
      document.getElementById(i)?.scrollIntoView({ behavior: 'smooth' });
    }, 200); // í˜ì´ì§€ ë¡œë”© ì‹œê°„ ê³ ë ¤í•´ì„œ ì•½ê°„ ëŒ€ê¸° (ì¡°ì • ê°€ëŠ¥)
  } else {
    document.getElementById(i)?.scrollIntoView({ behavior: 'smooth' });
  }
}
	 
//1. ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ê¸°
 function loadExam() {
	
	
   $.ajax({
     url: "/loadExam",
     type: "post",
     dataType: "json",
     data: { "category":category, "liIdx":liIdx },
     beforeSend: function(xhr) {
    	    xhr.setRequestHeader(header, token);  // â¬…ï¸ CSRF í† í° ê¼­ ë¶™ì—¬ì¤˜ì•¼ í•¨
    	  },
     success: function (data) {
       	   allExData = data;
       		// 10ê°œì”© ìª¼ê°œê¸°
       		for(let i = 0; i<100; i++){
       	  		 pbIdx[i] = allExData[i].pbId;
     }
		   for (let i = 0; i < allExData.length / 10; i++) {   // í˜ì´ì§€ ìˆ˜
			   let examSlice = [];

			   for (let j = 0; j < 10; j++) {     // ê° í˜ì´ì§€ë‹¹ 10ë¬¸ì œ
			     let idx = i * 10 + j; // 0~9ë²ˆë§Œ ë°˜ë³µë˜ì§€ ì•Šê²Œ i ê°’ *10ì„ ë”í•´ì£¼ê¸°
			     examSlice.push(allExData[idx]); // 10ê°œ ë°ì´í„° push
			     pbAns[idx] = allExData[idx].pbAns;
			   }

			   PageExam.push(examSlice); // 10ê°œë¡œ ë¬¶ì¸ ë°ì´í„° push
			 }
		  
		   renderPage();
		   
     },
     error: function () {
       alert("error");
     },
   });
 }


 // 2. ëœë”ë§
 function renderPage(pageNum = 0) {
	currentPage = pageNum;  // í˜„ì¬ í˜ì´ì§€ë¥¼ ì—…ë°ì´íŠ¸í•´ì¤Œ
   // í˜„ì¬ í˜ì´ì§€ì™€ í˜ì´ì§€ë‹¹ ë¬¸ì œ ìˆ˜ë¥¼ ê³±í•´ ì´ í˜ì´ì§€ì˜ ì²« ë²ˆì§¸ ë¬¸ì œ ì¸ë±ìŠ¤ë¥¼ ê³„ì‚°.
   const startIdx = currentPage * pageExamNum;
   const exam = PageExam[currentPage];
   let listHtml = "";	

   for (let j = 0; j < exam.length; j++) {
	     let problem = exam[j];
	   	 const qNum = startIdx + j + 1; // ë¬¸ì œ ë²ˆí˜¸
	     pbNum[j] = problem.pbNum; // ë¬¸ì œ ë²ˆí˜¸ ê°€ì§€ê³  ì˜¤ê¸° â†’ ê³¼ëª©ë³„ ì ìˆ˜ ê³„ì‚° í•  ë•Œ ì‚¬ìš©
	     
	     // í•œ ë¬¸ì œ div
	     listHtml += "<div class='oneExam' id='" + qNum + "' style='width: 50%;'>";
	     
	     // ë¬¸ì œ ì§€ë¬¸
	     listHtml += "<p><strong>ë¬¸ì œ" + qNum + ".</strong> " + problem.pbQues + "</p>";
	     // ë¬¸ì œ ë””í…Œì¼
	     if (problem.pbDetail != null) {
	       listHtml += "<br><div><img src='" + problem.pbDetail + "'></div><br>";
	     }

	     // ë¬¸ì œ ì„ ì§€
	     for (let k = 1; k <=4; k++) {
	       let choiceText = problem["pbChoi" + k];
	       const isSelected = userSelections[qNum] === k;
	       const choiceSymbol = isSelected ? "â—" : circledNumbers[k - 1];

	       // ë¬¸ì œ ì„ ì§€ ë¬¶ìŒ div
	       listHtml += "<div class='choice' id='choice" + qNum + "-" + k +
	                   "' onclick='selectChoice(" + qNum + "," + k + ", \"" + choiceText + "\")' style='display: flex; cursor:pointer;'>";

	       // ë¬¸ì œ ë²ˆí˜¸
		   listHtml += "<div class='oneChoiceNum' id='choiceNum" + qNum + "-" + k + "' style='font-family: monospace;'>" + choiceSymbol + " &nbsp; </div>";

	       // ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ íŒë‹¨
	       if (choiceText.includes("http")) {
	         listHtml += "<div class='oneChoice' id='choiceText" + qNum + "-" + k + "'><img src='" + choiceText + "'></div></div>";
	       } else {
	         listHtml += "<div class='oneChoiceText' id='choiceText" + qNum + "-" + k + "' ' >" + choiceText + "</div></div>";
	       }
	     }

	     listHtml += "<br></div>"; // í•œ ë¬¸ì œ ë
	     
	  // âœ… ë‹µì•ˆí‘œê¸°ë€ ì´ë¯¸ì§€ ë³µì›
	     for (let i = 1; i <= 100; i++) {
	         const selected = userSelections[i];
	         if (selected) {
	             $(`#number${i}-${selected}`).attr("src", "/images/marking.jpg");
	         }
	     }

	 }

   // ë²„íŠ¼ ë³´ì´ê¸° ì¡°ê±´ ì²˜ë¦¬
   const totalExamCount = PageExam.length * pageExamNum;
   document.getElementById("prev-page").style.display = currentPage > 0 ? "inline-block" : "none";
   document.getElementById("next-page").style.display = (currentPage + 1) * pageExamNum < totalExamCount ? "inline-block" : "none";

  	 $("#print").html(listHtml);
  	 
	   const maxPage = Math.floor(100 / pageExamNum);
	   $("#pageIndex").text((currentPage+1)+"/"+maxPage);
  	 
 	}
 
	
// ë²ˆí˜¸ í´ë¦­ì‹œ ë°œìƒí•˜ëŠ” í•¨ìˆ˜(ë¬¸ì œë²ˆí˜¸,ì„ ì§€ë²ˆí˜¸,ì„ ì§€ë‚´ìš©)
function selectChoice(questionNum, choiceNum) {
 
	  let current = parseInt($("#solCount").text(), 10); // ì•ˆ í‘¼ ë¬¸ì œ ìˆ˜ ì²´í¬í•˜ê¸° ìœ„í•´ í˜„ì¬ ìˆ«ì ì½ê¸°
	  $("#solCount").text(current -1);  // í’€ì—ˆì„ ê²½ìš° 1 ë¹¼ê¸°
	
 // ì„ íƒí•œ ì„ ì§€ë‚´ìš©
 const currentSelection = userSelections[questionNum];
 console.log("ì½˜ì†”: "+currentSelection);
 // ì§€ê¸ˆ í´ë¦­í•œ ì„ ì§€ê°€ ì´ë¯¸ ì„ íƒëœ ê²ƒê³¼ ê°™ì€ì§€ ë¹„êµí•˜ê¸° ìœ„í•¨.
 if (currentSelection === choiceNum) {
    // ê°™ì€ ë²ˆí˜¸ ë‹¤ì‹œ í´ë¦­ â†’ ì„ íƒ í•´ì œ
	    // ì„ íƒ í•´ì œ
	    delete userSelections[questionNum];
	    solvedStatus[questionNum] = 0; // ì•ˆ í‘¼ ìƒíƒœë¡œ ì„¤ì •
	    
	    $("#solCount").text(current +1);  // ê°™ì€ ë²ˆí˜¸ í´ë¦­ ì‹œ 1 ë‹¤ì‹œ ë”í•˜ê¸°
	    
	    
	    $(`#choiceNum${questionNum}-${choiceNum}`).text(circledNumbers[choiceNum - 1]);
	    $(`#number${questionNum}-${choiceNum}`).attr("src", `/images/n${choiceNum}.jpg`);

  } else {
    // ë‹¤ë¥¸ ë²ˆí˜¸ í´ë¦­ or ì²˜ìŒ ì„ íƒ â†’ ìƒˆë¡œ ì„ íƒ ì²˜ë¦¬
     const isFirstSelection = !userSelections[questionNum];
    userSelections[questionNum] = choiceNum;
    solvedStatus[questionNum] = choiceNum; // 1ë¡œ ìƒíƒœ ì €ì¥


    // ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì²´í¬ ì—†ëŠ” ì´ë¯¸ì§€ë¡œ ë³€ê²½ í›„ í´ë¦­í•œ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ì²´í¬í•œ ì´ë¯¸ì§€ë¡œ ë³€ê²½
    for (let i = 1; i <= 4; i++) {
        $(`#choiceNum${questionNum}-${i}`).text(circledNumbers[i - 1]);
        $(`#number${questionNum}-${i}`).attr("src", `/images/n${i}.jpg`);
      }
      $(`#choiceNum${questionNum}-${choiceNum}`).text("â—");
      
      $(`#number${questionNum}-${choiceNum}`).attr("src", "/images/marking.jpg");
    }
}
	
	

	function unsolved() {
		
		  const container = document.getElementById("unsolvedList");
		  container.innerHTML = ""; // ì´ˆê¸°í™”
		  
		  // ì•ˆ í‘¼ ë¬¸ì œ ë²ˆí˜¸ë“¤ ê°€ì ¸ì˜¤ê¸° (0 ë˜ëŠ” undefinedì¸ ë¬¸ì œë“¤)
		  const unsolved = [];
		  for (let i = 1; i <= 100; i++) {
		    if (solvedStatus[i] >= 1) {
		    }else{
		      unsolved.push(i);	    	
		    }
		  }
		  
			  if (unsolved.length === 0) {
				    container.innerHTML = "<p>ëª¨ë“  ë¬¸ì œë¥¼ í‘¸ì…¨ìŠµë‹ˆë‹¤!</p>";
				  } else {
				    unsolved.forEach(qNum => {
				      const btn = document.createElement("button");
				      btn.innerText = qNum;
				      //console.log(qNum);
				      btn.className = "btn btn-outline-secondary btn-sm";
				      btn.onclick = () => { // í´ë¦­ì‹œ ì´ë²¤íŠ¸
				    	    document.getElementById("unsolvedPopup").style.display = "none"; // íŒì—… ì°½ ì œê±°
				    	    goNum(qNum); // qNumìœ¼ë¡œ ì´ë™
 				      };
				      container.appendChild(btn);
				    });

				  }

				  document.getElementById("unsolvedPopup").style.display = "block";
				}

				function hideUnsolvedPopup() {
				  document.getElementById("unsolvedPopup").style.display = "none";
				}
				
				// ì‹œí—˜ ì œì¶œ í•¨ìˆ˜ (ì‹œì‘ì )
				function examSubmit() {
				  // ì•ˆ í‘¼ ë¬¸ì œëŠ” 0ìœ¼ë¡œ ì´ˆê¸°í™”
				  for (let i = 1; i <= 100; i++) {
				    if (solvedStatus[i] === undefined) {
				      solvedStatus[i] = 0;
				    }
				  }

			        // ì±„ì  ë¡œì§ ì‹¤í–‰ â†’ ì ìˆ˜ + ì „ì†¡ìš© ë°ì´í„° ìƒì„±
			        const result = gradeExam(pbAns,pbNum);

			     	// ë¡œë”©ì°½ ë„ìš°ê¸°
			        showLoading();
			     
			        // ì„œë²„ì— ì±„ì  ê²°ê³¼ ì „ì†¡
			        sendPbsData(result.pbsData).done(function () {
			     		// 1.5ì´ˆ(=1500ë°€ë¦¬ì´ˆ) í›„ì— ê²°ê³¼ UI ì—…ë°ì´íŠ¸ ì‹¤í–‰
			            setTimeout(function () {
			              updateResultUI(result.score);
			            }, 1500);
			          });
				}

				// ì±„ì  í•¨ìˆ˜: ì •ë‹µê³¼ ë¹„êµí•´ ì ìˆ˜ ê³„ì‚° ë° ì „ì†¡í•  ë°ì´í„° ì¤€ë¹„
				function gradeExam(correctData) {
				  const pbsCheck = [];                  // ë¬¸ì œë³„ ì •ì˜¤ ë°°ì—´
				  let score = 0;
				  const now = new Date(); // í˜„ì¬ ì‹œê°„ ê³„ì‚°
				  const pbsAt = now.getFullYear() + "-" +
				                String(now.getMonth() + 1).padStart(2, '0') + "-" +
				                String(now.getDate()).padStart(2, '0') + "T" +
				                String(now.getHours()).padStart(2, '0') + ":" +
				                String(now.getMinutes()).padStart(2, '0') + ":" +
				                String(now.getSeconds()).padStart(2, '0'); // dbì— ë“¤ì–´ê°ˆìˆ˜ìˆê²Œ í˜•íƒœ ìˆ˜ì •

				  for (let i = 1; i <= 100; i++) {
				    // ì •ë‹µ ë¹„êµí•˜ì—¬ ì ìˆ˜ ë° pbsCheck ì„¤ì •
				    if (solvedStatus[i] == pbAns[i - 1]) {
				      score++;
				      pbsCheck[i] = 1;
				    } else {
				      pbsCheck[i] = 0;
				    }

				    // ê°œë³„ ë¬¸ì œ ë°ì´í„° ê°ì²´ ìƒì„±í•˜ì—¬ ë°°ì—´ì— ì €ì¥
				    PbsData[i - 1] = {
				      pbNum: pbNum[i - 1],
				      userId: userId,
				      pbIdx: pbIdx[i - 1],
				      pbsCheck : pbsCheck[i],
				      pbsAt: pbsAt,
				    };
				  }

				  // ì ìˆ˜ì™€ ë°ì´í„° ë°˜í™˜
				  return { score, pbsData: PbsData };
				}

				// ì±„ì  ê²°ê³¼ë¥¼ ì„œë²„ì— ì „ì†¡í•˜ëŠ” Ajax
				function sendPbsData(pbsData) {					
					console.log("ğŸ“¦ ë³´ë‚´ëŠ” ë°ì´í„°:", pbsData);
					const exCat = $("#category").val(); // íšŒì°¨ ì •ë³´
					console.log("íšŒì°¨ ì¸ë±ìŠ¤: ", exCat);
					
				  return $.ajax({
				    url: `/submitPbsData?exCat=${encodeURIComponent(exCat)}`,
				    type: "post",
				    contentType: "application/json",
				    data: JSON.stringify(pbsData),
				    beforeSend: function(xhr) {
				        xhr.setRequestHeader(header, token);  // CSRF í† í° ì „ì†¡ (ìˆìœ¼ë©´)
				      },
				    success: function () {
				      console.log("ì±„ì  ê²°ê³¼ ì „ì†¡ ì™„ë£Œ");
				    },
				    error: function () {
				      alert("ì±„ì  ê²°ê³¼ ì „ì†¡ ì‹¤íŒ¨!");
				    }
				  });
				}

				// ì ìˆ˜ì— ë”°ë¼ UI í‘œì‹œ ë³€ê²½
				function updateResultUI(score) {
					
					$.ajax({
						url: "/chapResult/"+userId,
						type: "post",
						dataType: "json",
					    beforeSend: function(xhr) {
					    	   xhr.setRequestHeader(header, token);  // â¬…ï¸ CSRF í† í° ê¼­ ë¶™ì—¬ì¤˜ì•¼ í•¨
					    	 },
					     success: function (data) {
								const scoreBox = $("#scoreBox").clone(true); // ğŸ’¡ ì›ë˜ ì´ë²¤íŠ¸ ë“± ìœ ì§€í•˜ë©° ë³µì‚¬
								$("body").empty();                           // ğŸ”¥ body ì „ì²´ ë¹„ìš°ê³ 
								$("body").append(scoreBox);                  // âœ… #scoreBoxë§Œ ë‹¤ì‹œ ì¶”ê°€
								scoreBox.css("display", "flex");             // flex ì„¤ì •
								
								const liChap = data[0];
								
							    $("#liChap1").text(liChap.scChap1);
							    $("#liChap2").text(liChap.scChap2);
							    $("#liChap3").text(liChap.scChap3);
							    $("#liChap4").text(liChap.scChap4);
							    $("#liChap5").text(liChap.scChap5);


							   $("#score").text(score);                // ì ìˆ˜ ì¶œë ¥

							   if (score > 60) {
							     $("#comment").text("í•©ê²©ì„ ì¶•í•˜ë“œë¦½ë‹ˆë‹¤.");
							     $("#pass").text("í•©ê²©");
							   } else {
							     $("#comment").text("ë‹¤ìŒ ê¸°íšŒì— ê¼­ í•©ê²©í•˜ì‹œê¸¸ ê¸°ì›í•©ë‹ˆë‹¤.");
							     $("#pass").text("ë¶ˆí•©ê²©");
							   }
					    	 
					     },
					     error: function(){alert("ì—ëŸ¬ë‚¬ìŒ!");}
				
					});

				}
				
				function showLoading() {
					  $("#loadingOverlay").fadeIn();
					}

					function hideLoading() {
					  $("#loadingOverlay").fadeOut();
					}

		  


function prevPage() {
  if (currentPage > 0) {
	  renderPage(currentPage -1	);
    $(".test-page-block-holder").animate({ scrollTop: 0 }, 300); // 300ms ë™ì•ˆ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤ 0 ìœ¼ë¡œ ì´ë™
  }
}

function nextPage() {
	  const maxPage = Math.floor(100 / pageExamNum);
	  if (currentPage < maxPage - 1) {
	    currentPage++;
	    renderPage(currentPage);
    $(".test-page-block-holder").animate({ scrollTop: 0 }, 300); // 300ms ë™ì•ˆ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤ 0 ìœ¼ë¡œ ì´ë™
  }
}

function lotto(){
    // 10000000ë¶€í„° 99999999 ì‚¬ì´ì˜ ë¬´ì‘ìœ„ ì •ìˆ˜ ìƒì„±
    const number = Math.floor(Math.random() * 90000000) + 10000000;
    $("#lotto").val(number);
}
function lottoName() {
	  const words = ["ëª¨ì„±í˜„","ì†ì¢…í¬","ì´ì˜ë™","ì´ì¡°ì€","ì˜¤ì¥í›ˆ","ìµœìœ ì •"];
	  let result = "";


	    const randIndex = Math.floor(Math.random() * words.length);
	    result += words[randIndex];

	  $("#lottoName").val(result);
	}

  
function goToLicense() {
    if (liIdx) {
      window.location.href = "/license?liIdx=" + liIdx;
    } else {
      alert("liIdx ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
    }
  }
 
   </script>
   
   
</body>
</html>
