<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:inline="javascript">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>
<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>
<style>
    #chatbot-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        width: 300px;
        height: 400px;
        border: 1px solid #ccc;
        background: #fff;
        display: none;
        flex-direction: column;
        z-index: 1000;
    }
    #chatbot-header {
        background: #f8c107;
        padding: 10px;
        font-weight: bold;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #chatbot-body {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
        background: #f9f9f9;
    }
    #chatbot-input {
        display: flex;
        padding: 10px;
        border-top: 1px solid #ccc;
    }
    #chatbot-input input {
        flex: 1;
        border: 1px solid #ccc;
        padding: 5px;
        margin-right: 5px;
    }
    .chat-message {
        margin: 5px 0;
        padding: 8px;
        border-radius: 5px;
    }
    .user-message {
        background: #d1e7dd;
        margin-left: 20%;
    }
    .bot-message {
        background: #f8d7da;
        margin-right: 20%;
    }
</style>
</head>
<body>
	<div class="container">
		<h2 th:text="'자격증 이름: ' + ${liName}"></h2>
		<div class="panel panel-warning">
			<div class="panel-heading">
				examPage <span style="float: right;"> </span>
			</div>
			<div class="panel-body">

				<input type="hidden" id="category" th:value="${category}" />
				<div id="examBoard"></div>

			</div>
			<div class="panel-footer">빅데이터 개발자과정 - 손종희</div>
		</div>
	</div>
	
<!-- Thymeleaf에서 JS로 챕터명 전달 -->	
<script th:inline="javascript">
    const chapterTitles = [
        /*[[${liChap1}]]*/,
        /*[[${liChap2}]]*/,
        /*[[${liChap3}]]*/,
        /*[[${liChap4}]]*/,
        /*[[${liChap5}]]*/
    ];
</script>
	<script type="text/javascript">
	$(document).ready(function(){
		// ready() : html 코드가 준비가 되면 실행되는 메소드
		// 게시글을 모두 가져올 수 있는 메소드!

    // 챗봇 메시지 전송
    function sendChatbotMessage() {
        let message = $("#chatbot-message").val().trim();
        let pbId = $("#chatbot-pbId").val();
        if (message === "") return;

	   let exData = []; // 모든 데이터 담아주기. 그 후 여기서 쪼개자
	   let shufData = []; // 모든 선지 데이터 담아주기. 그 후 여기서 쪼개자
	   let subjectExam = []; // 쪼개진 데이터들(20개씩)
	   let subjectshuf = []; // 쪼개진 데이터들()

        $.ajax({
            url: "/chatbot/" + pbId,
            type: "post",
            data: JSON.stringify({ question: message }),
            contentType: "application/json",
            dataType: "text",
            success: function(data) {
                $("#chatbot-body").append(`<div class="chat-message bot-message">${data}</div>`);
                $("#chatbot-body").scrollTop($("#chatbot-body")[0].scrollHeight);
            },
            error: function() {
                $("#chatbot-body").append(`<div class="chat-message bot-message">오류가 발생했습니다.</div>`);
                $("#chatbot-body").scrollTop($("#chatbot-body")[0].scrollHeight);
            }
        });
    }

 	// 챗봇 버튼 클릭
    function askChatbot(pbNum) {
        $("#chatbot-container").show();
        $("#chatbot-pbId").val(pbNum);
        $("#chatbot-body").html("");
        $("#chatbot-body").append(`<div class="chat-message bot-message">문제 ${pbNum}에 대해 질문이 있으면 말씀해주세요!</div>`);
        $("#chatbot-body").scrollTop($("#chatbot-body")[0].scrollHeight);
    }

    // 문제 불러오는 함수
    function loadExam() {
        let exData = [];
        let shufData = [];
        const category = $("#category").val();

        $.when(
            $.ajax({ url: "/loadExam/"+category, type: "post", dataType: "json"}),
            $.ajax({ url: "/shuffle/"+category, type: "post", dataType: "json"})
        ).done(function(examData, shuffleData) {
            exData = examData[0];
            shufData = shuffleData[0];
            let listHtml = "";

            if ($("#examBoard").html().trim() === "") {
                $.each(shufData, function(index, options) {
                    const pbId = exData[index].pbId-1;
                    const pbNum = exData[index].pbNum;
                    listHtml += "<div style='break-inside: avoid;'>";
                    listHtml += "<div id='examYear"+(index+1)+"'>(출제일)</div>";
                    listHtml += "<div style='position: relative; width: fit-content; max-width: 100%;'>" +
                                "<img id='check"+(index+1)+"' style='position:absolute; top: -25px; left: -30px; width: 100px; height: 100px; display: none;' alt=''>" +
                                (index + 1) + ". " + exData[index].pbQues + "</div>";
                    if(exData[index].pbDetail != null) {
                        listHtml += "<br><div><img src='"+ exData[index].pbDetail +"'></div><br>";
                    }
                    listHtml += "<div id='choice" + (index+1) + "-1' onclick='selectChoice(" + (index+1) + ",1, \"" + options[0] + "\")' style='display: flex;' >";
                    listHtml += "<div id='choiceNum" + (index+1) + "-1' class='cell'> ①   </div>";
                    if(options[0].includes("http")) {
                        listHtml += "<div id='choiceText" + (index+1) + "-1' ><img src='"+ options[0] + "'></div></div>";
                    } else {
                        listHtml += "<div id='choiceText" + (index+1) + "-1' >"+ options[0] + "</div></div>";
                    }
                    listHtml += "<div id='choice" + (index+1) + "-2' onclick='selectChoice(" + (index+1) + ",2, \"" + options[1] + "\")' style='display: flex;' >";
                    listHtml += "<div id='choiceNum" + (index+1) + "-2' > ②   </div>";
                    if(options[1].includes("http")) {
                        listHtml += "<div id='choiceText" + (index+1) + "-2' ><img src='"+ options[1] + "'></div></div>";
                    } else {
                        listHtml += "<div id='choiceText" + (index+1) + "-2'>"+ options[1] + "</div></div>";
                    }
                    listHtml += "<div id='choice" + (index+1) + "-3' onclick='selectChoice(" + (index+1) + ",3, \"" + options[2] + "\")' style='display: flex;' >";
                    listHtml += "<div id='choiceNum" + (index+1) + "-3' >③   </div>";
                    if(options[2].includes("http")) {
                        listHtml += "<div id='choiceText" + (index+1) + "-3' ><img src='"+ options[2] + "'></div></div>";
                    } else {
                        listHtml += "<div id='choiceText" + (index+1) + "-3'>"+ options[2] + "</div></div>";
                    }
                    listHtml += "<div id='choice" + (index+1) + "-4' onclick='selectChoice(" + (index+1) + ",4, \"" + options[3] + "\")' style='display: flex;' >";
                    listHtml += "<div id='choiceNum" + (index+1) + "-4' >④   </div>";
                    if(options[3].includes("http")) {
                        listHtml += "<div id='choiceText" + (index+1) + "-4' ><img src='"+ options[3] + "'></div></div>";
                    } else {
                        listHtml += "<div id='choiceText" + (index+1) + "-4'>"+ options[3] + "</div></div>";
                    }
                    listHtml += "<br>";
                    listHtml += "<button id='pbans"+index+"' onclick='correctAnswer("+pbId+", " + index + ")'>정답 확인</button>   ";
                    listHtml += "<button onclick='solution("+pbId+", " + index + ")'>해설</button>   ";
                    listHtml += "<button onclick='askChatbot("+pbNum+")'>챗봇에게 물어보기</button>";
                    listHtml += "<br><br>";
                    listHtml += "<div id='solution"+index+"'></div>";
                    listHtml += "</div><br>";
                });
                $("#examBoard").html(listHtml);
            }
        }).fail(function() {
            alert("Error!");
        });
    }

	     // examData, shuffleData는 배열 형태 ([data, status, jqXHR])
	     // examData, shuffleData = [실제데이터, "success", jqXHR 객체]
	     // 그래서 [0]번째 데이터 추출
	     exData = examData[0];
	     shufData = shuffleData[0];
		   let subjectExam = [];
		   let subjectshuf = [];
		   
		   for (let i = 0; i < 5; i++) {        // 과목 5개
			   let examSlice = [];
			   let shufSlice = [];

			   for (let j = 0; j < 20; j++) {     // 각 과목당 20문제
			     let idx = i * 20 + j; // 0~19번만 반복되지 않게 i 값 *20을 더해주기
			     examSlice.push(exData[idx]); // 20개 데이터 push
			     shufSlice.push(shufData[idx]); // 20개 데이터 push
			   }

			   subjectExam.push(examSlice); // 20개로 묶인 데이터 push
			   subjectshuf.push(shufSlice);
			 }
	     
	     
	     
	     let listHtml = "";
	     
	     
	     $.each(subjectshuf, function(subjectIdx, problemList) {
	    	  listHtml += "<h4 style='margin-top: 30px; font-size:50px; font-weight: bold; text-align: center;'>"
	    	           + chapterTitles[subjectIdx]
	    	           + "</h4>";
	    	  listHtml += "<p><hr></p>"         
			  listHtml += "<div style='column-count: 2; column-gap: 40px;'>"
	    	  $.each(problemList, function(questionIdx, options) {
	    	    const globalIdx = subjectIdx * 20 + questionIdx;
	    	    const pbId = exData[globalIdx].pbId - 1;

	    	    listHtml += "<div style='break-inside: avoid;'>";
	    	    listHtml += "<div id='examYear" + (globalIdx + 1) + "'></div>";

	    	    listHtml += "<div style='position: relative; width: fit-content; max-width: 100%;'>" +
	    	                "<img id='check" + (globalIdx + 1) + "' style='position:absolute; top: -25px; left: -30px; width: 100px; height: 100px; display: none;' alt=''>" +
	    	                (globalIdx + 1) + ". " + exData[globalIdx].pbQues + "</div>";

	    	    if (exData[globalIdx].pbDetail != null) {
	    	      listHtml += "<br><div><img src='" + exData[globalIdx].pbDetail + "'></div><br>";
	    	    }

	    	    for (let k = 0; k < 4; k++) {
	    	      listHtml += "<div id='choice" + (globalIdx + 1) + "-" + (k + 1) + "' onclick='selectChoice(" + (globalIdx + 1) + "," + (k + 1) + ", \"" + options[k] + "\")' style='display: flex;'>";
	    	      listHtml += "<div id='choiceNum" + (globalIdx + 1) + "-" + (k + 1) + "'> " + ["①", "②", "③", "④"][k] + " &nbsp; </div>";
	    	      if (options[k].includes("http")) {
	    	        listHtml += "<div id='choiceText" + (globalIdx + 1) + "-" + (k + 1) + "'><img src='" + options[k] + "'></div></div>";
	    	      } else {
	    	        listHtml += "<div id='choiceText" + (globalIdx + 1) + "-" + (k + 1) + "'>" + options[k] + "</div></div>";
	    	      }
	    	    }

	    	    listHtml += "<br>";
	    	    listHtml += "<button id='pbans" + globalIdx + "' onclick='correctAnswer(" + pbId + ", " + globalIdx + ")'>정답 확인</button> &nbsp;";
	    	    listHtml += "<button onclick='solution(" + pbId + ", " + globalIdx + ")'>해설</button>";
	    	    listHtml += "<br><br>";
	    	    listHtml += "<div id='solution" + globalIdx + "'></div>";
	    	    listHtml += "</div><br>";
	    	  });
			  listHtml += "</div>"
	    	});

	       // div의 id가 examBoard인 부분에 listHtml 추가
	       $("#examBoard").html(listHtml);
	   }).fail(function() { // 실패시
	     alert("Error!"); // 오류시 출력문
	   });
   
    // 정답 확인
    function correctAnswer(pbId, index) {
        $.ajax({
            url: "/correctAnswer/"+pbId,
            type: "put",
            data: {},
            dataType: "text",
            success: function(data) {
                if ($("#pbans"+index).text().trim() === "정답 확인") {
                    for (let i = 1; i <= 4; i++) {
                        let choiceText = $("#choiceText" + (index + 1) + "-" + i).text().trim();
                        if (choiceText === data.trim()) {
                            $("#choice" + (index + 1) + "-" + i).css("color", "red");
                        }
                    }
                    if(userSelections[index+1] === data) {
                        $("#check" + (index+1)).css("display","block");
                        $("#check" + (index+1)).attr("src","/images/o.png");
                    } else {
                        $("#check" + (index+1)).css("display","block");
                        $("#check" + (index+1)).attr("src","/images/x.png");
                    }
                }
            },
            error: function() { alert("Error!"); }
        });
    }

    // 해설
    function solution(pbId, index) {
        $.ajax({
            url: "/solution/"+pbId,
            type: "put",
            dataType: "text",
            success: function(data) {
                if ($("#solution"+index).text().trim() === "") {
                    $("#solution"+index).text(data);
                } else {
                    $("#solution"+index).text("");
                }
            },
            error: function() { alert("Error!"); }
        });
    }

    // 문제 번호 : 선택 선지 텍스트
    const userSelections = {};

    function selectChoice(questionNum, choiceNum, choiceText) {
        const currentSelection = userSelections[questionNum];
        if (currentSelection === choiceText) {
            delete userSelections[questionNum];
            for(let i=1; i<=4; i++) {
                $("[id='choiceNum" + questionNum + "-" + i + "']").css("font-weight","normal");
                $("[id='choiceText" + questionNum + "-" + i + "']").css("font-weight", "normal");
            }
        } else {
            userSelections[questionNum] = choiceText;
            for(let i=1; i<=4; i++) {
                $("[id='choiceNum" + questionNum + "-" + i + "']").css("font-weight","normal");
                $("[id='choiceText" + questionNum + "-" + i + "']").css("font-weight", "normal");
            }
            $("[id='choiceNum" + questionNum + "-" + choiceNum + "']").css("font-weight", "900");
            $("[id='choiceText" + questionNum + "-" + choiceNum + "']").css("font-weight", "900");
        }
    }
    </script>
</body>
</html>