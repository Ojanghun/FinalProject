<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
	th:inline="javascript">
<head>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>Exam Page</title>
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
	rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/exam.css">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

<style>
.loading-spinner {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-style: italic;
}

.loading-spinner .spinner-icon {
    animation: spin 1s linear infinite;
    font-size: 1.2rem;
}

/* íšŒì „ ì• ë‹ˆë©”ì´ì…˜ */
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>


</head>
<body>
	<nav class="custom-header border-bottom bg-white py-2">
		<div class="container">
			<div class="d-flex justify-content-between align-items-start w-100">

				<!-- ì¢Œì¸¡: ë¡œê³  -->
				<a href="/" class="d-flex align-items-start"> <img
					src="/images/ë¡œê³ .png" alt="ë¡œê³ " style="height: 48px; width: auto;">
				</a>

				<!-- ìš°ì¸¡: ë’¤ë¡œê°€ê¸° + ë§ˆì´í˜ì´ì§€ + ë¡œê·¸ì•„ì›ƒ -->
				<div class="d-flex align-items-start gap-2">
					<button type="button" class="btn btn-outline-warning"
						onclick="goToLicense()">ë’¤ë¡œê°€ê¸°</button>
					<a href="/mypage" class="btn btn-outline-secondary">MYPAGE</a>
					<form th:action="@{/logout}" method="post" class="d-inline">
                  <input type="hidden" th:name="${_csrf.parameterName}"
                     th:value="${_csrf.token}" />
                  <button type="submit" class="btn btn-outline-danger">LOGOUT</button>
               </form>
				</div>

			</div>
		</div>
	</nav>


	<div class="panel panel-warning">
		
		<div class="exam-title-bar">
			<h3 style='font-weight: 550;' th:text="${liName} +' ê¸°ì¶œ'"></h3>
			<span style="float: right;"></span>
		</div>
		<div class="panel-body">
			<input type="hidden" id="category" th:value="${category}" />
			<div class="container" id="examBoard"></div>
			<div id="pagination" class="text-center mt-4"></div>
		</div>
	</div>
	<!-- Footer -->
	<footer class="footer mt-5 py-4 border-top">
		<div class="container text-center">
			<nav class="nav justify-content-center mb-3">
				<a href="#" class="footer-link">Home</a> <a href="#"
					class="footer-link">About</a> <a href="#" class="footer-link">Contact</a>
			</nav>
			<p class="text-muted small mb-0">Â© 2025 ë¬¸ì œ Issue!</p>
		</div>
	</footer>

	<input type="hidden" id="category" th:value="${category}" />
	<input type="hidden" id="liIdx" th:value="${liIdx}" />
	<div id="examBoard"></div>


	<!-- Thymeleafì—ì„œ JSë¡œ ì±•í„°ëª… ì „ë‹¬ -->
	<script th:inline="javascript">
    const chapterTitles = [
        /*[[${liChap1}]]*/,
        /*[[${liChap2}]]*/,
        /*[[${liChap3}]]*/,
        /*[[${liChap4}]]*/,
        /*[[${liChap5}]]*/
    ];
</script>

	<script type="text/javascript">
let exData = [];
let shufData = [];
let currentPage = 0;
const userSelections = {};
const liIdx = $("#liIdx").val();

$(document).ready(function(){
    loadExam();
});

function loadExam() {
    const category = $("#category").val();

    $.when(
            $.ajax({ url: "/loadExam", type: "post", dataType: "json", data:{ "category":category, "liIdx":liIdx }}),
            $.ajax({ url: "/shuffle", type: "post", dataType: "json", data:{ "category":category, "liIdx":liIdx }})
    ).done(function (examData, shuffleData) {
        exData = examData[0];
        shufData = shuffleData[0];
        renderPage(0);
    }).fail(function () {
        alert("Error!");
    });
}

function renderPage(pageIndex) {
    currentPage = pageIndex;
    const startIdx = pageIndex * 20;
    const endIdx = startIdx + 20;
    let listHtml = "";

    listHtml += "<div class='exam-section'>";
    listHtml += "<h4 class='subjectIdx'>" + chapterTitles[pageIndex] + "</h4><hr>";
    listHtml += "<div class='column-wrapper'>"; 
    

    for (let idx = startIdx; idx < endIdx; idx++) {
        const pb = exData[idx];
        const options = shufData[idx];
        const globalIdx = idx;
        const pbId = pb.pbId - 1;

        listHtml += "<div class='oneExam'>";
        listHtml += "<div id='examYear" + (globalIdx + 1) + "'></div>";
        listHtml += "<div class='question'><img id='check" + (globalIdx + 1) + "' style='position:absolute; top: -25px; left: -30px; width: 100px; height: 100px; display: none;' alt=''>" +
                    (globalIdx + 1) + ". " + pb.pbQues + "</div>";

        if (pb.pbDetail) {
            listHtml += "<br><div><img src='" + pb.pbDetail + "'></div><br>";
        }

        for (let k = 0; k < 4; k++) {
            const choice = options[k];
            listHtml += "<div class='choice' id='choice" + (globalIdx + 1) + "-" + (k + 1) + "' onclick='selectChoice(" + (globalIdx + 1) + "," + (k + 1) + ", \"" + choice + "\")'>";
            listHtml += "<div id='choiceNum" + (globalIdx + 1) + "-" + (k + 1) + "'> " + ["â‘ ", "â‘¡", "â‘¢", "â‘£"][k] + " &nbsp; </div>";
            if (choice.includes("http")) {
                listHtml += "<div id='choiceText" + (globalIdx + 1) + "-" + (k + 1) + "'><img src='" + choice + "'></div>";
            } else {
                listHtml += "<div id='choiceText" + (globalIdx + 1) + "-" + (k + 1) + "'>" + choice + "</div>";
            }
            listHtml += "</div>";
        }


    	    	    listHtml += "<br>";
    	    	    listHtml += "<button class='btn btn-outline-info' id='pbans" + globalIdx + "' onclick='correctAnswer(" + pbId + ", " + globalIdx + ")'>ì •ë‹µ í™•ì¸</button> &nbsp;";
    	    	    listHtml += "<button class='btn btn-outline-warning' onclick='solution(" + pbId + ", " + globalIdx + ")'>í•´ì„¤</button> &nbsp;";
    	    	    listHtml += "<button class='btn btn-outline-dark' onclick='showChatBox(" + pbId + ", " + globalIdx + ")'>ì±—ë´‡ì—ê²Œ ë¬»ê¸°</button> &nbsp;";
    	    	    listHtml += "<br><br>";
    	    	    listHtml += "<div class='solution' id='solution" + globalIdx + "'></div>";
    	    	    listHtml += "</div><br>";

    }

    listHtml += "</div>"; // end column-wrapper
    listHtml += "</div>"; // end exam-section

    
    $("#examBoard").html(listHtml);
    renderPagination();
}

function renderPagination() {
	
	// âœ… í˜ì´ì§€ ë°”ë€” ë•Œ ë§¨ ìœ„ë¡œ ìŠ¤í¬ë¡¤ ì´ë™
    window.scrollTo({ top: 0});
	
    let html = '<ul class="pagination justify-content-center" style="display:flex; 	flex-direction: row; gap:5px;">';

    // << ì²˜ìŒìœ¼ë¡œ
    html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
                <button class="page-link" onclick="renderPage(0)">â‰ª</button>
             </li>`;
             
             for (let i = 0; i < 5; i++) {
             html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                         <button class="page-link" onclick="renderPage(${i})">${i + 1}</button>
                      </li>`;
             }
			    // >> ë§ˆì§€ë§‰ìœ¼ë¡œ
			    html += `<li class="page-item ${currentPage === 4 ? 'disabled' : ''}">
			                <button class="page-link" onclick="renderPage(4)">â‰«</button>
			             </li>`;

			    html += '</ul>';
			    $("#pagination").html(html);
	    	}

   
    // ì •ë‹µ í™•ì¸
    function correctAnswer(pbId, index) {
    $.ajax({
        url: "/correctAnswer/" + pbId,
        type: "put",
        data: {},
        dataType: "text",
        success: function (data) {
            if ($("#pbans" + index).text().trim() === "ì •ë‹µ í™•ì¸") {

                // ğŸ”´ ë¶‰ì€ ì› ê°•ì¡° ì¶”ê°€ (ë¬¸ì œ ë²ˆí˜¸ ì˜ì—­ì— ì‚½ì…)
                $("#examYear" + (index + 1)).html(`
				  <span class="circle-highlight">${index + 1}.</span>
				`);

                // ğŸ” ì •ë‹µ ìƒ‰ìƒ í‘œì‹œ
                for (let i = 1; i <= 4; i++) {
                    let choiceText = $("#choiceText" + questionNum + "-" + i).text().trim();
                    if (choiceText === data.trim()) {
                        $("#choice" + questionNum + "-" + i).css("color", "red");
                    }
                }

                // âœ… O/X ì´ë¯¸ì§€
                if (userSelections[questionNum] === data) {
                    $("#check" + questionNum).show().attr("src", "/images/o.png");
                } else {
                    $("#check" + questionNum).show().attr("src", "/images/x.png");
                }
            }
        },
        error: function () {
            alert("Error!");
        }
    });
}

function selectChoice(questionNum, choiceNum, choiceText) {
    const currentSelection = userSelections[questionNum];
    if (currentSelection === choiceText) {
        delete userSelections[questionNum];
    } else {
        userSelections[questionNum] = choiceText;
    }

    for(let i=1; i<=4; i++) {
        $("#choiceNum" + questionNum + "-" + i).css("font-weight", "normal");
        $("#choiceText" + questionNum + "-" + i).css("font-weight", "normal");
    }

    if (userSelections[questionNum]) {
        $("#choiceNum" + questionNum + "-" + choiceNum).css("font-weight", "bold");
        $("#choiceText" + questionNum + "-" + choiceNum).css("font-weight", "bold");
    }
}

function correctAnswer(pbId, index) {
    $.ajax({
        url: "/correctAnswer/" + pbId,
        type: "put",
        dataType: "text",
        success: function(data) {
            if ($("#pbans" + index).text().trim() === "ì •ë‹µ í™•ì¸") {
            	document.getElementById("examYear" + (index + 1)).scrollIntoView({ behavior: 'smooth', block: 'start' });
                for (let i = 1; i <= 4; i++) {
                    let choiceText = $("#choiceText" + (index + 1) + "-" + i).text().trim();
                    if (choiceText === data.trim()) {
                        $("#choice" + (index + 1) + "-" + i).css("color", "red");
                    }
                }

                if (userSelections[index + 1] === data) {
                    $("#check" + (index + 1)).show().attr("src", "/images/o.png");
                } else {
                    $("#check" + (index + 1)).show().attr("src", "/images/x.png");
                }
            }
        },
        error: function() {
            alert("Error!");
        }
    });
}

function solution(pbId, index){
    const target = $("#solution" + index);

    if (target.is(":visible")) {
        target.slideUp();
        return;
    }

    $.ajax({
        url: "/solution/" + pbId,
        type: "put",
        dataType: "text",
        success: function(data) {
            if (data && data.trim() !== "") {
                target.html(data.replace(/\n/g, "<br>")); // ì¤„ë°”ê¿ˆ ì²˜ë¦¬
                target.slideDown();
            } else {
                target.html("<em>í•´ì„¤ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</em>").slideDown();
            }
        },
        error: function() {
            alert("í•´ì„¤ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
        }
    });
}


function goToLicense() {
    if (liIdx) {
      window.location.href = "/license?liIdx=" + liIdx;
    } else {
      alert("liIdx ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
    }
  }

const token = $("meta[name='_csrf']").attr("content");
const header = $("meta[name='_csrf_header']").attr("content");

function showChatBox(pbId, index) {
    const chatBoxId = "chatBox" + index;
    const existingBox = document.getElementById(chatBoxId);

    if (existingBox) {
        existingBox.style.display = existingBox.style.display === "none" ? "block" : "none";
        return;
    }

    const boxHtml = `
        <div id="${chatBoxId}" class="chatbox-container mt-3 p-3 rounded shadow-sm border">
            <label for="chatInput${index}" class="form-label fw-bold">â“ ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•´ë³´ì„¸ìš”</label>
            <textarea class="form-control mb-2" id="chatInput${index}" rows="3" placeholder="ì˜ˆ: ì´ ë¬¸ì œì˜ í•µì‹¬ ê°œë…ì€ ë¬´ì—‡ì¸ê°€ìš”?" onkeydown="submitChatOnEnter(event, ${pbId}, ${index})"></textarea>
            <div class="d-flex justify-content-end">
                <button class="btn btn-sm btn-primary" onclick="sendToChatbot(${pbId}, ${index})" id="chatSendBtn${index}">
                    <i class="bi bi-send-fill"></i> ì „ì†¡
                </button>
            </div>
            <div id="chatAnswer${index}" class="chat-answer mt-3" style="display: none;"></div>
        </div>
    `;
    $("#solution" + index).after(boxHtml);
}

function sendToChatbot(pbId, index) {
    const question = $("#chatInput" + index).val().trim();
    if (!question) {
        alert("ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    const pb = exData[index];
    const options = shufData[index];

    const payload = {
        question: question,
        pbQues: pb.pbQues,
        choices: options
    };

    $.ajax({
        url: "/askChatbot",
        type: "POST",
        contentType: "application/json",
        data: JSON.stringify(payload),
        beforeSend: function(xhr) {
            xhr.setRequestHeader(header, token);
            $("#chatAnswer" + index).html(`
                <div class="loading-spinner">
                    <span>ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</span>
                </div>
            `).show();
            $("#chatSendBtn" + index).hide(); // ğŸ”’ ì „ì†¡ ë²„íŠ¼ ìˆ¨ê¹€
        },
        success: function(response) {
            $("#chatAnswer" + index).html(`<i class="bi bi-chat-dots-fill text-primary me-2"></i>${response.answer}`).show();
            $("#chatSendBtn" + index).show(); // ğŸ”“ ì „ì†¡ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
        },
        error: function() {
            $("#chatAnswer" + index).html(`<span class="text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>`).show();
            $("#chatSendBtn" + index).show(); // ğŸ”“ ì „ì†¡ ë²„íŠ¼ ë‹¤ì‹œ í‘œì‹œ
        }
    });
}

function submitChatOnEnter(event, pbId, index) {
    if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        sendToChatbot(pbId, index);
    }
}

    </script>
</body>
</html>
