<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:inline="javascript">
<head>
<meta charset="UTF-8">
<title>Topic page</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/exam.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

</head>
<body>
      <nav class="custom-header border-bottom bg-white py-2">
		  <div class="container d-flex justify-content-between align-items-center">
		    <div class="d-flex align-items-center gap-2">
		      <a href="/" class="d-flex align-items-center gap-2 ">
		        <img src="/images/로고.png" height="40" style="height: 48px; width: auto;" alt="로고">
		        <span class="fw-bold text-dark"></span>
		      </a>
		    </div>
		    <div class="d-flex gap-2">
		      <button type="button" class="btn btn-outline-warning" onclick="goToLicense()">뒤로가기</button>
		      <a href="/mypage" class="btn btn-outline-secondary">MYPAGE</a>
		      <a href="/logout" class="btn btn-outline-danger">LOGOUT</a>
		    </div>
		  </div>
		</nav>
		
      <div class="panel panel-warning">
             <div>
		    </div>
     		<div class="exam-title-bar">
                <input type="hidden" id="category" th:value="${category}" />
                <h3 id="examTopic" style="text-align:center; font-weight: 550; color:white;"></h3>
            </div>
	        <div class="panel-body">
         		<input type="hidden" id="category" th:value="${category}" />
         		<input type="hidden" id="liIdx" th:value="${liIdx}" />
                <div class="container" id="examBoard" ></div>
                <div id="pagination" class="text-center mt-4"></div>
         </div>
      </div>
      
      
 <!-- footer -->
<footer class="footer mt-5 py-4 border-top">
	  <div class="container text-center">
	    <nav class="nav justify-content-center mb-3">
	      <a href="#" class="footer-link">Home</a>
	      <a href="#" class="footer-link">About</a>
	      <a href="#" class="footer-link">Contact</a>
	    </nav>
	    <p class="text-muted small mb-0">© 2025 문제 Issue!</p>
	  </div>
	</footer>
   
   <script th:inline="javascript">
    const chapterTitles = [
        /*[[${liChap1}]]*/,
        /*[[${liChap2}]]*/,
        /*[[${liChap3}]]*/,
        /*[[${liChap4}]]*/,
        /*[[${liChap5}]]*/
    ];
</script>
   
   <script type="text/javascript">
   let exData = [];
   let shufData = [];
   
	$(document).ready(function(){
		// ready() : html 코드가 준비가 되면 실행되는 메소드
		// 게시글을 모두 가져올 수 있는 메소드!
		loadExam();
		topic();
		
	});
	
	const category = $("#category").val();
	const liIdx = $("#liIdx").val();
   
   // 문제 불러오는 함수
   function loadExam() {
	   console.log("카테고리 값: " + category);

	   $.when(
	     $.ajax({ url: "/loadExam", type: "post", dataType: "json", data:{ "category":category, "liIdx":liIdx }}),
	     $.ajax({ url: "/shuffle", type: "post", dataType: "json", data:{ "category":category, "liIdx":liIdx }})
	   ).done(function(examData, shuffleData) {
	     exData = examData[0];
	     shufData = shuffleData[0];
	     renderPage(0);  // ✅ 첫 페이지 출력
	   }).fail(function() {
	     alert("문제 데이터를 불러오지 못했습니다.");
	   });
	 }
   
   function topic(){
	   $.ajax({
		 url : "/loadTopic/"+category,
		 type : "post",
		 dataType :"json",
		 success : function(data){
			 
			 const topic = data[0]; 
			 console.log(data);
			 
			 listHtml = "";
			 
			 listHtml += topic.topicName;
			 
			 $("#examTopic").html(listHtml);
			 renderPagination();
		 },
		 error : function(){alert("Error!");}
	   });
	   
   }
   function renderPage(pageIndex) {
	    const totalPages = Math.ceil(exData.length / 20);
	    if (pageIndex < 0 || pageIndex >= totalPages) return;

	    currentPage = pageIndex;
	    const startIdx = pageIndex * 20;
	    const endIdx = startIdx + 20;
	    let listHtml = "";

	    listHtml += "<div class='exam-section'>";
	    listHtml += "<h4 class='subjectIdx'>" + (chapterTitles[pageIndex] || "") + "</h4><hr>";
	    listHtml += "<div class='column-wrapper'>";

	    for (let idx = startIdx; idx < endIdx && idx < exData.length; idx++) {
	        const pb = exData[idx];
	        const options = shufData[idx];
	        const pbId = pb.pbId - 1;

	        listHtml += "<div class='oneExam'>";
	        listHtml += "<div id='examYear" + (idx + 1) + "'></div>";
	        listHtml += "<div class='question'><img id='check" + (idx + 1) + "' style='position:absolute; top: -25px; left: -30px; width: 100px; height: 100px; display: none;' alt=''>" +
	                    (idx + 1) + ". " + pb.pbQues + "</div>";

	        if (pb.pbDetail) {
	            listHtml += "<br><div><img src='" + pb.pbDetail + "'></div><br>";
	        }

	        for (let k = 0; k < 4; k++) {
	            const choice = options[k];
	            listHtml += "<div class='choice' id='choice" + (idx + 1) + "-" + (k + 1) + "' onclick='selectChoice(" + (idx + 1) + "," + (k + 1) + ", \"" + choice + "\")'>";
	            listHtml += "<div id='choiceNum" + (idx + 1) + "-" + (k + 1) + "'> " + ["①", "②", "③", "④"][k] + " &nbsp; </div>";
	            if (choice.includes("http")) {
	                listHtml += "<div id='choiceText" + (idx + 1) + "-" + (k + 1) + "'><img src='" + choice + "'></div>";
	            } else {
	                listHtml += "<div id='choiceText" + (idx + 1) + "-" + (k + 1) + "'>" + choice + "</div>";
	            }
	            listHtml += "</div>";
	        }

	        listHtml += "<br>";
	        listHtml += "<button class='btn btn-outline-info' id='pbans" + idx + "' onclick='correctAnswer(" + pbId + ", " + idx + ")'>정답 확인</button> ";
	        listHtml += "<button class='btn btn-outline-warning' onclick='solution(" + pbId + ", " + idx + ")'>해설</button>";
	        listHtml += "<div class='solution' id='solution" + idx + "'></div>";
	        listHtml += "</div>";
	    }

	    listHtml += "</div>"; // column-wrapper
	    listHtml += "</div>"; // exam-section

	    $("#examBoard").html(listHtml);
	    renderPagination();
	}

   function renderPagination() {
	    window.scrollTo({ top: 0 });

	    const totalPages = Math.ceil(exData.length / 20);

	    let html = '<ul class="pagination justify-content-center">';

	    // << 처음으로
	    html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
	                <button class="page-link" onclick="renderPage(0)">≪</button>
	             </li>`;

	    // 페이지 번호
	    for (let i = 0; i < totalPages; i++) {
	        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
	                    <button class="page-link" onclick="renderPage(${i})">${i + 1}</button>
	                 </li>`;
	    }

	    // >> 마지막으로
	    html += `<li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
	                <button class="page-link" onclick="renderPage(${totalPages - 1})">≫</button>
	             </li>`;

	    html += '</ul>';
	    $("#pagination").html(html);
	}

	function selectChoice(questionNum, choiceNum, choiceText) {
	    const currentSelection = userSelections[questionNum];
	    if (currentSelection === choiceText) {
	        delete userSelections[questionNum];
	    } else {
	        userSelections[questionNum] = choiceText;
	    }

	    for(let i=1; i<=4; i++) {
	        $("#choiceNum" + questionNum + "-" + i).css("font-weight", "normal");
	        $("#choiceText" + questionNum + "-" + i).css("font-weight", "normal");
	    }

	    if (userSelections[questionNum]) {
	        $("#choiceNum" + questionNum + "-" + choiceNum).css("font-weight", "bold");
	        $("#choiceText" + questionNum + "-" + choiceNum).css("font-weight", "bold");
	    }
	}
   
    function correctAnswer(pbId, index){
    	
    	$.ajax({
    		url : "/correctAnswer/"+pbId,
    		type : "put",
    		dataType : "text",
    		success : function(data){
    			console.log("받은 data: ", data);
    			 if ($("#pbans"+index).text().trim() === "정답 확인") {
    				 document.getElementById("examYear" + (index + 1)).scrollIntoView({ behavior: 'smooth', block: 'start' });	
    				 // 정답 텍스트와 일치하는 보기 찾아서 빨간색 적용
    					for (let i = 1; i <= 4; i++) {
    						let choiceText = $("#choiceText" + (index + 1) + "-" + i).text().trim();
    						if (choiceText === data.trim()) {
    							$("#choice" + (index + 1) + "-" + i).css("color", "red");
    				    		$("#passRate" + (index+1)).css("display","block");
    				    		$("#pbans"+index).prop("disabled", true);
    						}
    					}
    				    if(userSelections[index+1] === data){
    				    	console.log("클릭 data: ", userSelections[index+1]);
    				    	$("#check" + (index+1)).css("display","block");
    				    	$("#check" + (index+1)).attr("src","/images/o.png");
    				    	$("#pbans"+index).prop("disabled", true);

    				    }
    				    else{
    				    	console.log("클릭 data: ", userSelections);
    				    	$("#check" + (index+1)).css("display","block");
    				    	$("#check" + (index+1)).attr("src","/images/x.png");
    				    }
    				}
/*     			 else {
    				    $("#pbans"+index).text("정답 확인");
    				} */
    		},
    		error : function(){alert("Error!");}
    	});

    }
    
    // 해결책
    function solution(pbId, index){
  const target = $("#solution" + index);

  // 이미 열려 있으면 닫기
  if (target.is(":visible")) {
    target.slideUp();
    return;
  }

  // 열려있지 않으면 서버 요청 후 열기
  $.ajax({
    url: "/solution/" + pbId,
    type: "put",
    dataType: "text",
    success: function(data){
      target.html(data);  // 텍스트 그대로 넣되, pre-wrap이 줄바꿈 처리
      target.slideDown(); // 애니메이션으로 열기
    },
    error: function(){
      alert("해설 불러오기 실패");
    }
  });
}
   
	// 문제 번호 : 선택 선지 텍스트
	const userSelections = {};  // 선택한 답을 계속 저장하고, 클릭할 때마다 그 내용을 유지하면서 갱신하기 위해 밖에 선언.

	// 번호 클릭시 발생하는 함수(문제번호,선지번호,선지내용)
    function selectChoice(questionNum, choiceNum, choiceText) {
	 
	 // 선택한 선지내용
     const currentSelection = userSelections[questionNum];
     
	 // 지금 클릭한 선지가 이미 선택된 것과 같은지 비교하기 위함.
     if (currentSelection === choiceText) {
        // 같은 번호 다시 클릭 → 선택 해제
        delete userSelections[questionNum];

        // 문제 번호에 해당하는 모든 선택지 이미지 원복
        for(let i=1; i<=4; i++) {
          //document.getElementById("choice" + questionNum + "-" + i).src = "/images/" + i + ".gif"
          $("[id='choiceNum" + questionNum + "-" + i + "']").css("font-weight","normal");
          $("[id='choiceText" + questionNum + "-" + i + "']").css("font-weight", "normal");
        }
        console.log("문제 " + questionNum + " 선택 해제", userSelections);

      } else {
        // 다른 번호 클릭 or 처음 선택 → 새로 선택 처리
        userSelections[questionNum] = choiceText;


        // 모든 이미지를 체크 없는 이미지로 변경 후 클릭한 이미지를 다시 체크한 이미지로 변경
        for(let i=1; i<=4; i++) {
          //1~4번 이미지를 체크 없는 이미지로 변경.
          //document.getElementById("choice" + questionNum + "-" + i).src = "/images/" + i + ".gif";
          $("[id='choiceNum" + questionNum + "-" + i + "']").css("font-weight","normal");
          $("[id='choiceText" + questionNum + "-" + i + "']").css("font-weight", "normal");
        }
        // 클릭한 이미지를 체크한 이미지로 변경하기
        //document.getElementById("choice" + questionNum + "-" + choiceNum).src = "/images/" + choiceNum + "red.gif";
		//$("[id='choiceNum" + questionNum + "-" + choiceNum + "']").css("font-weight", "bold");
		$("[id='choiceNum" + questionNum + "-" + choiceNum + "']").css("font-weight", "900");
		//$("[id='choiceText" + questionNum + "-" + choiceNum + "']").css("font-weight", "bold");
		$("[id='choiceText" + questionNum + "-" + choiceNum + "']").css("font-weight", "900");
        // console.log("문제 " + questionNum + " 선택 변경", userSelections);
      }
    }
	
    function goToLicense() {
        if (liIdx) {
          window.location.href = "/license?liIdx=" + liIdx;
        } else {
          alert("liIdx 값이 없습니다.");
        }
      }
 
   </script>
   
   
</body>
</html>
