<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" th:inline="javascript">
<head>
<meta charset="UTF-8">
<meta name="_csrf" th:content="${_csrf.token}" />
<meta name="_csrf_header" th:content="${_csrf.headerName}" />
<title>Topic page</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="/css/exam.css">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<script src="https://cdn.portone.io/v2/browser-sdk.js"></script>

<style>
.loading-spinner {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #6c757d;
    font-style: italic;
}
.loading-spinner .spinner-icon {
    animation: spin 1s linear infinite;
    font-size: 1.2rem;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>

</head>
<body>
      <nav class="custom-header border-bottom bg-white py-2">
		  <div class="container d-flex justify-content-between align-items-center">
		    <div class="d-flex align-items-center gap-2">
		      <a href="/" class="d-flex align-items-center gap-2 ">
		        <img src="/images/ë¡œê³ .png" height="40" style="height: 48px; width: auto;" alt="ë¡œê³ ">
		        <span class="fw-bold text-dark"></span>
		      </a>
		    </div>
		    <div class="d-flex gap-2">
		      <button type="button" class="btn btn-outline-warning" onclick="goToLicense()">ë’¤ë¡œê°€ê¸°</button>
		      <a href="/mypage" class="btn btn-outline-secondary">MYPAGE</a>
		      <a href="/logout" class="btn btn-outline-danger">LOGOUT</a>
		    </div>
		  </div>
		</nav>
		
      <div class="panel panel-warning">
             <div>
		    </div>
     		<div class="exam-title-bar">
                <input type="hidden" id="category" th:value="${category}" />
                <h3 id="examTopic" style="text-align:center; font-weight: 550; color:white;"></h3>
            </div>
	        <div class="panel-body">
         		<input type="hidden" id="category" th:value="${category}" />
         		<input type="hidden" id="liIdx" th:value="${liIdx}" />
                <div class="container" id="examBoard" ></div>
                <div id="pagination" class="text-center mt-4"></div>
         </div>
      </div>
      
      
 <!-- footer -->
<footer class="footer mt-5 py-4 border-top">
	  <div class="container text-center">
	    <nav class="nav justify-content-center mb-3">
	      <a href="#" class="footer-link">Home</a>
	      <a href="#" class="footer-link">About</a>
	      <a href="#" class="footer-link">Contact</a>
	    </nav>
	    <p class="text-muted small mb-0">Â© 2025 ë¬¸ì œ Issue!</p>
	  </div>
	</footer>
   
   <script th:inline="javascript">
    const chapterTitles = [
        /*[[${liChap1}]]*/,
        /*[[${liChap2}]]*/,
        /*[[${liChap3}]]*/,
        /*[[${liChap4}]]*/,
        /*[[${liChap5}]]*/
    ];
</script>
   
   <script type="text/javascript">
   let exData = [];
   let shufData = [];
   let currentPage = 0;
   let token;
   let header;
   
	$(document).ready(function(){
		// ready() : html ì½”ë“œê°€ ì¤€ë¹„ê°€ ë˜ë©´ ì‹¤í–‰ë˜ëŠ” ë©”ì†Œë“œ
		// ê²Œì‹œê¸€ì„ ëª¨ë‘ ê°€ì ¸ì˜¬ ìˆ˜ ìˆëŠ” ë©”ì†Œë“œ!
		token = $("meta[name='_csrf']").attr("content");
    	header = $("meta[name='_csrf_header']").attr("content");
    	
    	console.log("ğŸ” token =", token);
    	console.log("ğŸ” header =", header);  // ë°˜ë“œì‹œ 'X-CSRF-TOKEN' ë˜ëŠ” ìœ ì‚¬ ë¬¸ìì—´ì´ì–´ì•¼ í•¨
    	 
		loadExam();
		topic();
		
	});
	
	const category = $("#category").val();
	const liIdx = $("#liIdx").val();
   
   // ë¬¸ì œ ë¶ˆëŸ¬ì˜¤ëŠ” í•¨ìˆ˜
   function loadExam() {
	   console.log("ì¹´í…Œê³ ë¦¬ ê°’: " + category);

	   $.when(
	     $.ajax({ url: "/loadExam", type: "post", dataType: "json", data:{ "category":category, "liIdx":liIdx }}),
	     $.ajax({ url: "/shuffle", type: "post", dataType: "json", data:{ "category":category, "liIdx":liIdx }})
	   ).done(function(examData, shuffleData) {
	     exData = examData[0];
	     shufData = shuffleData[0];
	     renderPage(0);  // âœ… ì²« í˜ì´ì§€ ì¶œë ¥
	   }).fail(function() {
	     alert("ë¬¸ì œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
	   });
	 }
   
   function topic(){
	   $.ajax({
		 url : "/loadTopic/"+category,
		 type : "post",
		 dataType :"json",
		 success : function(data){
			 
			 const topic = data[0]; 
			 console.log(data);
			 
			 listHtml = "";
			 
			 listHtml += topic.topicName;
			 
			 $("#examTopic").html(listHtml);
			 renderPagination();
		 },
		 error : function(){alert("Error!");}
	   });
	   
   }
   function renderPage(pageIndex) {
	    const totalPages = Math.ceil(exData.length / 20);
	    if (pageIndex < 0 || pageIndex >= totalPages) return;

	    currentPage = pageIndex;
	    const startIdx = pageIndex * 20;
	    const endIdx = startIdx + 20;
	    let listHtml = "";

	    listHtml += "<div class='exam-section'>";
	    listHtml += "<h4 class='subjectIdx'>" + (chapterTitles[pageIndex] || "") + "</h4><hr>";
	    listHtml += "<div class='column-wrapper'>";

	    for (let idx = startIdx; idx < endIdx && idx < exData.length; idx++) {
	        const pb = exData[idx];
	        const options = shufData[idx];
	        const pbId = pb.pbId - 1;

	        listHtml += "<div class='oneExam'>";
	        listHtml += "<div id='examYear" + (idx + 1) + "'></div>";
	        listHtml += "<div class='question'><img id='check" + (idx + 1) + "' style='position:absolute; top: -25px; left: -30px; width: 100px; height: 100px; display: none;' alt=''>" +
	                    (idx + 1) + ". " + pb.pbQues + "</div>";

	        if (pb.pbDetail) {
	            listHtml += "<br><div><img src='" + pb.pbDetail + "'></div><br>";
	        }

	        for (let k = 0; k < 4; k++) {
	            const choice = options[k];
	            listHtml += "<div class='choice' id='choice" + (idx + 1) + "-" + (k + 1) + "' onclick='selectChoice(" + (idx + 1) + "," + (k + 1) + ", \"" + choice + "\")'>";
	            listHtml += "<div id='choiceNum" + (idx + 1) + "-" + (k + 1) + "'> " + ["â‘ ", "â‘¡", "â‘¢", "â‘£"][k] + " &nbsp; </div>";
	            if (choice.includes("http")) {
	                listHtml += "<div id='choiceText" + (idx + 1) + "-" + (k + 1) + "'><img src='" + choice + "'></div>";
	            } else {
	                listHtml += "<div id='choiceText" + (idx + 1) + "-" + (k + 1) + "'>" + choice + "</div>";
	            }
	            listHtml += "</div>";
	        }

	        listHtml += "<br>";
	        listHtml += "<button class='btn btn-outline-info' id='pbans" + idx + "' onclick='correctAnswer(" + pbId + ", " + idx + ")'>ì •ë‹µ í™•ì¸</button> ";
	        listHtml += "<button class='btn btn-outline-warning' onclick='solution(" + pbId + ", " + idx + ")'>í•´ì„¤</button>";
	        listHtml += "<button class='btn btn-outline-dark' onclick='showChatBox(" + pbId + ", " + idx + ")'>ì±—ë´‡ì—ê²Œ ë¬»ê¸°</button>";
    	    listHtml += "<br><br>";
	        listHtml += "<div class='solution' id='solution" + idx + "'></div>";
	        listHtml += "</div>";
	    }

	    listHtml += "</div>"; // column-wrapper
	    listHtml += "</div>"; // exam-section

	    $("#examBoard").html(listHtml);
	    renderPagination();
	}
   
   function showChatBox(pbId, index) {
	    const chatBoxId = "chatBox" + index;
	    const existingBox = document.getElementById(chatBoxId);

	    if (existingBox) {
	        existingBox.style.display = existingBox.style.display === "none" ? "block" : "none";
	        return;
	    }

	    const boxHtml = `
	        <div id="${chatBoxId}" class="chatbox-container mt-3 p-3 rounded shadow-sm border">
	            <label for="chatInput${index}" class="form-label fw-bold">â“ ê¶ê¸ˆí•œ ì ì„ ì…ë ¥í•´ë³´ì„¸ìš”</label>
	            <textarea class="form-control mb-2" id="chatInput${index}" rows="3" placeholder="ì˜ˆ: ì´ ë¬¸ì œì˜ í•µì‹¬ ê°œë…ì€ ë¬´ì—‡ì¸ê°€ìš”?"></textarea>
	            <div class="d-flex justify-content-end">
	                <button class="btn btn-sm btn-primary" onclick="sendToChatbot(${pbId}, ${index})">
	                    <i class="bi bi-send-fill"></i> ì „ì†¡
	                </button>
	            </div>
	            <div id="chatAnswer${index}" class="chat-answer mt-3" style="display: none;"></div>
	        </div>
	    `;
	    $("#solution" + index).after(boxHtml);
	}

   function sendToChatbot(pbId, index) {
	    const question = $("#chatInput" + index).val().trim();
	    if (!question) {
	        alert("ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
	        return;
	    }

	    const pb = exData[index];
	    const options = shufData[index];

	    const payload = {
	        question: question,
	        pbQues: pb.pbQues,
	        choices: options
	    };

	    $.ajax({
	        url: "/askChatbot",
	        type: "POST",
	        contentType: "application/json",
	        data: JSON.stringify(payload),
	        beforeSend: function(xhr) {
	            xhr.setRequestHeader(header, token);
	            $("#chatAnswer" + index).html(`
	                <div class="loading-spinner">
	                    <span>ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...</span>
	                </div>
	            `).show();
	        },
	        success: function(response) {
	            $("#chatAnswer" + index).html(`<i class="bi bi-chat-dots-fill text-primary me-2"></i>${response.answer}`).show();
	        },
	        error: function() {
	            $("#chatAnswer" + index).html(`<span class="text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</span>`).show();
	        }
	    });
	}

   function renderPagination() {
	    window.scrollTo({ top: 0 });

	    const totalPages = Math.ceil(exData.length / 20);

	    let html = '<ul class="pagination justify-content-center">';

	    // << ì²˜ìŒìœ¼ë¡œ
	    html += `<li class="page-item ${currentPage === 0 ? 'disabled' : ''}">
	                <button class="page-link" onclick="renderPage(0)">â‰ª</button>
	             </li>`;

	    // í˜ì´ì§€ ë²ˆí˜¸
	    for (let i = 0; i < totalPages; i++) {
	        html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
	                    <button class="page-link" onclick="renderPage(${i})">${i + 1}</button>
	                 </li>`;
	    }

	    // >> ë§ˆì§€ë§‰ìœ¼ë¡œ
	    html += `<li class="page-item ${currentPage === totalPages - 1 ? 'disabled' : ''}">
	                <button class="page-link" onclick="renderPage(${totalPages - 1})">â‰«</button>
	             </li>`;

	    html += '</ul>';
	    $("#pagination").html(html);
	}

	function selectChoice(questionNum, choiceNum, choiceText) {
	    const currentSelection = userSelections[questionNum];
	    if (currentSelection === choiceText) {
	        delete userSelections[questionNum];
	    } else {
	        userSelections[questionNum] = choiceText;
	    }

	    for(let i=1; i<=4; i++) {
	        $("#choiceNum" + questionNum + "-" + i).css("font-weight", "normal");
	        $("#choiceText" + questionNum + "-" + i).css("font-weight", "normal");
	    }

	    if (userSelections[questionNum]) {
	        $("#choiceNum" + questionNum + "-" + choiceNum).css("font-weight", "bold");
	        $("#choiceText" + questionNum + "-" + choiceNum).css("font-weight", "bold");
	    }
	}
   
    function correctAnswer(pbId, index){
    	
    	$.ajax({
    		url : "/correctAnswer/"+pbId,
    		type : "put",
    		dataType : "text",
    		success : function(data){
    			console.log("ë°›ì€ data: ", data);
    			 if ($("#pbans"+index).text().trim() === "ì •ë‹µ í™•ì¸") {
    				 document.getElementById("examYear" + (index + 1)).scrollIntoView({ behavior: 'smooth', block: 'start' });	
    				 // ì •ë‹µ í…ìŠ¤íŠ¸ì™€ ì¼ì¹˜í•˜ëŠ” ë³´ê¸° ì°¾ì•„ì„œ ë¹¨ê°„ìƒ‰ ì ìš©
    					for (let i = 1; i <= 4; i++) {
    						let choiceText = $("#choiceText" + (index + 1) + "-" + i).text().trim();
    						if (choiceText === data.trim()) {
    							$("#choice" + (index + 1) + "-" + i).css("color", "red");
    				    		$("#passRate" + (index+1)).css("display","block");
    				    		$("#pbans"+index).prop("disabled", true);
    						}
    					}
    				    if(userSelections[index+1] === data){
    				    	console.log("í´ë¦­ data: ", userSelections[index+1]);
    				    	$("#check" + (index+1)).css("display","block");
    				    	$("#check" + (index+1)).attr("src","/images/o.png");
    				    	$("#pbans"+index).prop("disabled", true);

    				    }
    				    else{
    				    	console.log("í´ë¦­ data: ", userSelections);
    				    	$("#check" + (index+1)).css("display","block");
    				    	$("#check" + (index+1)).attr("src","/images/x.png");
    				    }
    				}
/*     			 else {
    				    $("#pbans"+index).text("ì •ë‹µ í™•ì¸");
    				} */
    		},
    		error : function(){alert("Error!");}
    	});

    }
    
    // í•´ê²°ì±…
    function solution(pbId, index){
  const target = $("#solution" + index);

  // ì´ë¯¸ ì—´ë ¤ ìˆìœ¼ë©´ ë‹«ê¸°
  if (target.is(":visible")) {
    target.slideUp();
    return;
  }

  // ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ì„œë²„ ìš”ì²­ í›„ ì—´ê¸°
  $.ajax({
    url: "/solution/" + pbId,
    type: "put",
    dataType: "text",
    success: function(data){
      target.html(data);  // í…ìŠ¤íŠ¸ ê·¸ëŒ€ë¡œ ë„£ë˜, pre-wrapì´ ì¤„ë°”ê¿ˆ ì²˜ë¦¬
      target.slideDown(); // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ ì—´ê¸°
    },
    error: function(){
      alert("í•´ì„¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
    }
  });
}
   
	// ë¬¸ì œ ë²ˆí˜¸ : ì„ íƒ ì„ ì§€ í…ìŠ¤íŠ¸
	const userSelections = {};  // ì„ íƒí•œ ë‹µì„ ê³„ì† ì €ì¥í•˜ê³ , í´ë¦­í•  ë•Œë§ˆë‹¤ ê·¸ ë‚´ìš©ì„ ìœ ì§€í•˜ë©´ì„œ ê°±ì‹ í•˜ê¸° ìœ„í•´ ë°–ì— ì„ ì–¸.

	// ë²ˆí˜¸ í´ë¦­ì‹œ ë°œìƒí•˜ëŠ” í•¨ìˆ˜(ë¬¸ì œë²ˆí˜¸,ì„ ì§€ë²ˆí˜¸,ì„ ì§€ë‚´ìš©)
    function selectChoice(questionNum, choiceNum, choiceText) {
	 
	 // ì„ íƒí•œ ì„ ì§€ë‚´ìš©
     const currentSelection = userSelections[questionNum];
     
	 // ì§€ê¸ˆ í´ë¦­í•œ ì„ ì§€ê°€ ì´ë¯¸ ì„ íƒëœ ê²ƒê³¼ ê°™ì€ì§€ ë¹„êµí•˜ê¸° ìœ„í•¨.
     if (currentSelection === choiceText) {
        // ê°™ì€ ë²ˆí˜¸ ë‹¤ì‹œ í´ë¦­ â†’ ì„ íƒ í•´ì œ
        delete userSelections[questionNum];

        // ë¬¸ì œ ë²ˆí˜¸ì— í•´ë‹¹í•˜ëŠ” ëª¨ë“  ì„ íƒì§€ ì´ë¯¸ì§€ ì›ë³µ
        for(let i=1; i<=4; i++) {
          //document.getElementById("choice" + questionNum + "-" + i).src = "/images/" + i + ".gif"
          $("[id='choiceNum" + questionNum + "-" + i + "']").css("font-weight","normal");
          $("[id='choiceText" + questionNum + "-" + i + "']").css("font-weight", "normal");
        }
        console.log("ë¬¸ì œ " + questionNum + " ì„ íƒ í•´ì œ", userSelections);

      } else {
        // ë‹¤ë¥¸ ë²ˆí˜¸ í´ë¦­ or ì²˜ìŒ ì„ íƒ â†’ ìƒˆë¡œ ì„ íƒ ì²˜ë¦¬
        userSelections[questionNum] = choiceText;


        // ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ì²´í¬ ì—†ëŠ” ì´ë¯¸ì§€ë¡œ ë³€ê²½ í›„ í´ë¦­í•œ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ì²´í¬í•œ ì´ë¯¸ì§€ë¡œ ë³€ê²½
        for(let i=1; i<=4; i++) {
          //1~4ë²ˆ ì´ë¯¸ì§€ë¥¼ ì²´í¬ ì—†ëŠ” ì´ë¯¸ì§€ë¡œ ë³€ê²½.
          //document.getElementById("choice" + questionNum + "-" + i).src = "/images/" + i + ".gif";
          $("[id='choiceNum" + questionNum + "-" + i + "']").css("font-weight","normal");
          $("[id='choiceText" + questionNum + "-" + i + "']").css("font-weight", "normal");
        }
        // í´ë¦­í•œ ì´ë¯¸ì§€ë¥¼ ì²´í¬í•œ ì´ë¯¸ì§€ë¡œ ë³€ê²½í•˜ê¸°
        //document.getElementById("choice" + questionNum + "-" + choiceNum).src = "/images/" + choiceNum + "red.gif";
		//$("[id='choiceNum" + questionNum + "-" + choiceNum + "']").css("font-weight", "bold");
		$("[id='choiceNum" + questionNum + "-" + choiceNum + "']").css("font-weight", "900");
		//$("[id='choiceText" + questionNum + "-" + choiceNum + "']").css("font-weight", "bold");
		$("[id='choiceText" + questionNum + "-" + choiceNum + "']").css("font-weight", "900");
        // console.log("ë¬¸ì œ " + questionNum + " ì„ íƒ ë³€ê²½", userSelections);
      }
    }
	
    function goToLicense() {
        if (liIdx) {
          window.location.href = "/license?liIdx=" + liIdx;
        } else {
          alert("liIdx ê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
        }
      }
 
   </script>
   
   
</body>
</html>
