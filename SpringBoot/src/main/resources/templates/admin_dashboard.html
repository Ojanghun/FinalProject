<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
<meta charset="UTF-8">
<title>ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</title>
 <!-- âœ… CSRF ë³´í˜¸ìš© í† í° ë©”íƒ€ íƒœê·¸ -->
  <meta name="_csrf" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:content="${_csrf.headerName}">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
body {
	display: flex;
	margin: 0;
}

.sidebar {
	width: 220px;
	background-color: #f8f9fa;
	padding: 20px;
	border-right: 1px solid #ddd;
	height: 100vh;
}

.content {
	flex: 1;
	padding: 40px;
	overflow-y: auto;
}

.menu-item {
	cursor: pointer;
	padding: 10px;
	border-radius: 5px;
}

.menu-item:hover {
	background-color: #e9ecef;
}

.section-content {
	display: none;
}

.section-content.active {
	display: block;
}

.back-btn {
	margin-bottom: 20px;
}
</style>
</head>
<body>
	<!-- ì‚¬ì´ë“œë°” -->
	<div class="sidebar">
		<h4>ğŸ“‚ ë©”ë‰´</h4>
		<div class="menu-item" onclick="showUserSection()">ğŸ‘¤ íšŒì› ì •ë³´</div>
		<div class="menu-item" onclick="showSection('questionSection')">ğŸ§ 
			ë¬¸ì œ ìˆ˜</div>
		<div class="menu-item" onclick="showSection('wrongRateSection')">âŒ
			ì˜¤ë‹µë¥ </div>
		<div class="menu-item"
			onclick="showSection('refundRateSection'); fetchRefundPage()">ğŸ’¸
			í™˜ê¸‰ë¥ </div>
		<div class="menu-item" onclick="showSection('planUsageSection')">ğŸ“Š
			í”Œëœ ì´ìš© í˜„í™©</div>
		<div class="menu-item" onclick="goToAllRefundRequests()">ğŸ“ í™˜ê¸‰
			ìš”ì²­ ë³´ê¸°</div>
		<div class="menu-item" onclick="showSection('refundCompleteSection')">âœ…
			í™˜ê¸‰ ì™„ë£Œ ë³´ê¸°</div>

	</div>

	<!-- ë³¸ë¬¸ ì½˜í…ì¸  -->
	<div class="content container">
		<section id="userSection" class="section-content active">
			<h4>ğŸ‘¤ íšŒì› ì •ë³´</h4>
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>ì•„ì´ë””</th>
						<th>ì´ë¦„</th>
						<th>ì „í™”ë²ˆí˜¸</th>
						<th>í¬ì¸íŠ¸</th>
						<th>ê°€ì…ì¼</th>
					</tr>
				</thead>
				<tbody id="userTableBody">
					<tr>
						<td colspan="5">ğŸ‘† ìƒë‹¨ 'íšŒì› ì •ë³´'ë¥¼ í´ë¦­í•´ì„œ ë°ì´í„°ë¥¼ ì¡°íšŒí•˜ì„¸ìš”.</td>
					</tr>
					<!-- âœ… ì´ˆê¸° ë©”ì‹œì§€ -->
				</tbody>
			</table>
		</section>

		<!-- ë¬¸ì œ ìˆ˜ -->
		<section id="questionSection" class="section-content">
			<h4>ğŸ§  ìê²©ì¦ë³„ ì£¼ì œë³„ ë¬¸ì œ ìˆ˜</h4>
			<div class="mb-3" id="licenseButtons">
				<button class="btn btn-outline-primary btn-sm"
					onclick="filterByLicense('ì „ì²´')">ì „ì²´ ë³´ê¸°</button>
				<span th:each="liName : ${licenseNames}">
					<button class="btn btn-outline-primary btn-sm" th:text="${liName}"
						th:attr="onclick=|filterByLicense('${liName}')|"></button>
				</span>
			</div>
			<table class="table table-striped" id="questionTable">
				<thead>
					<tr>
						<th>ìê²©ì¦</th>
						<th>ì£¼ì œ ì´ë¦„</th>
						<th>ì£¼ì œ ID</th>
						<th>ë¬¸ì œ ìˆ˜</th>
						<th>ì˜¤ë‹µë¥ </th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="count : ${topicQuestionCounts}">
						<td th:text="${count.liName}"></td>
						<td th:text="${count.topicName}"></td>
						<td th:text="${count.topicIdx}"></td>
						<td th:text="${count.count}"></td>
						<td th:text="${count.wrongRate + '%'}"></td>
					</tr>
				</tbody>
			</table>
		</section>

		<!-- ì˜¤ë‹µë¥  -->
		<section id="wrongRateSection" class="section-content">
			<h4>âŒ ì˜¤ë‹µë¥ </h4>
			<div class="mb-3" id="wrongLicenseButtons">
				<span th:each="liName : ${licenseNames}">
					<button class="btn btn-outline-primary btn-sm" th:text="${liName}"
						th:attr="onclick=|filterWrongByLicense('${liName}')|"></button>
				</span>
			</div>
			<canvas id="wrongRateChart" height="100"></canvas>
			<div class="d-flex justify-content-between align-items-center mt-3">
				<button class="btn btn-outline-secondary" onclick="prevPage()">ì´ì „</button>
				<span id="pageNum">1</span> / <span id="totalPages">?</span>
				<button class="btn btn-outline-secondary" onclick="nextPage()">ë‹¤ìŒ</button>
			</div>
		</section>

		<section id="refundRateSection" class="section-content">
			<h4>ğŸ’¸ í™˜ê¸‰ë¥ </h4>
			<div class="mb-3" id="refundLicenseButtons">
				<button class="btn btn-outline-primary btn-sm"
					onclick="filterRefundByLicense('ì „ì²´')">ì „ì²´ ë³´ê¸°</button>
				<span th:each="liName : ${licenseNames}">
					<button class="btn btn-outline-primary btn-sm" th:text="${liName}"
						th:attr="onclick=|filterRefundByLicense('${liName}')|"></button>
				</span>
			</div>
			<div id="refundChartWrapper" style="display: none;">
				<canvas id="refundRateChart" height="100"></canvas>
				<div class="d-flex justify-content-between align-items-center mt-3">
					<button class="btn btn-outline-secondary"
						onclick="prevRefundPage()">ì´ì „</button>
					<span id="refundPageNum">1</span> / <span id="refundTotalPages">?</span>
					<button class="btn btn-outline-secondary"
						onclick="nextRefundPage()">ë‹¤ìŒ</button>
				</div>
			</div>
			<div id="noRefundDataMsg" class="text-muted">ğŸ“‰ í™˜ê¸‰ë¥  ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
		</section>

		<!-- ê²°ì œ ì •ë³´ -->
		<section id="payInfoSection" class="section-content">
			<button class="btn btn-secondary back-btn"
				onclick="showUserSection()">â† ë’¤ë¡œê°€ê¸°</button>
			<h4>
				ğŸ’³ ê²°ì œ ì •ë³´ (<span id="selectedUserId">íšŒì› ì„ íƒ</span>)
			</h4>
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>í”Œëœ ì´ë¦„</th>
						<th>ê²°ì œì¼</th>
						<th>ê¸ˆì•¡</th>
					</tr>
				</thead>
				<tbody id="payInfoBody">
					<tr>
						<td colspan="3">íšŒì› í´ë¦­ ì‹œ ì •ë³´ í‘œì‹œë¨</td>
					</tr>
				</tbody>
			</table>
		</section>
		<!-- ğŸ“Š í”Œëœ ì´ìš©ì ìˆ˜ ì„¹ì…˜ -->
		<section id="planUsageSection" class="section-content">
			<h4>ğŸ“Š ìê²©ì¦ë³„ í”Œëœ ì´ìš© í˜„í™©</h4>
			<div class="mb-3" id="planLicenseButtons">
				<span th:each="liName : ${licenseNames}">
					<button class="btn btn-outline-primary btn-sm" th:text="${liName}"
						th:attr="onclick=|loadPlanUsage('${liName}')|"></button>
				</span>
			</div>
			<table class="table table-bordered" id="planUsageTable">
				<thead>
					<tr>
						<th>í”Œëœ ì¢…ë¥˜</th>
						<th>ì´ìš©ì ìˆ˜</th>
						<th>ë¹„ìœ¨ (%)</th>
						<th>í™˜ê¸‰ë¥  (%)</th>
					</tr>
				</thead>
				<tbody></tbody>
			</table>
		</section>
	
		<section id="refundRequestSection" class="section-content">
			<h4>ğŸ“ í™˜ê¸‰ ìš”ì²­ ì •ë³´</h4>
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>ìê²©ì¦</th>
						<th>í”Œëœ</th>
						<th>ê°€ê²©</th>
						<th>ì˜ˆê¸ˆì£¼</th>
						<th>ì€í–‰</th>
						<th>ê³„ì¢Œ</th>
						<th>ìš”ì²­ì¼</th>
						<th>ë™ì˜ìƒ</th>
						<th>ìŠ¹ì¸</th>
					</tr>
				</thead>
				<tbody>
					<tr th:each="req : ${session.refundInfoList}">
						<td th:text="${req.liName}"></td>
						<td th:text="${req.planType}"></td>
						<td
							th:text="${#numbers.formatInteger(req.planPrice, 3, 'COMMA')} + 'ì›'"></td>
						<td th:text="${req.rfName}"></td>
						<td th:text="${req.rfBank}"></td>
						<td th:text="${req.rfAccnum}"></td>
						<td th:text="${#temporals.format(req.rfAt, 'yyyy-MM-dd HH:mm')}"></td>
						
						<td><a th:href="@{${req.rfVpath}}" target="_blank"
							th:if="${req.rfVpath != null}">ë³´ê¸°</a> <span
							th:if="${req.rfVpath == null}">ì—†ìŒ</span></td>
						<td>
							<button class="btn btn-sm btn-success"
								th:onclick="|approveRefund(${req.rfIdx})|">ìŠ¹ì¸</button>
						</td>
					</tr>
				</tbody>
			</table>
		</section>
		<!-- í™˜ê¸‰ ì™„ë£Œ ë³´ê¸° -->
		<section id="refundCompleteSection" class="section-content">
			<h4>âœ… í™˜ê¸‰ ì™„ë£Œ ë‚´ì—­</h4>
			<table class="table table-bordered">
				<thead>
					<tr>
						<th>ìê²©ì¦</th>
						<th>í”Œëœ</th>
						<th>ê°€ê²©</th>
						<th>ì˜ˆê¸ˆì£¼</th>
						<th>ì€í–‰</th>
						<th>ê³„ì¢Œ</th>
						<th>ìš”ì²­ì¼</th>
						<th>ìŠ¹ì¸ì¼</th> <!-- ì¶”ê°€ -->
					</tr>
				</thead>
				<tbody>
					<tr th:each="req : ${session.refundCompletedList}">
						<td th:text="${req.liName}"></td>
						<td th:text="${req.planType}"></td>
						<td
							th:text="${#numbers.formatInteger(req.planPrice, 3, 'COMMA')} + 'ì›'"></td>
						<td th:text="${req.rfName}"></td>
						<td th:text="${req.rfBank}"></td>
						<td th:text="${req.rfAccnum}"></td>
						<td th:text="${#temporals.format(req.rfAt, 'yyyy-MM-dd HH:mm')}"></td>
						<td th:text="${#temporals.format(req.apAt, 'yyyy-MM-dd HH:mm')}"></td> <!-- ìŠ¹ì¸ì¼ -->
					</tr>
				</tbody>
			</table>
		</section>
	</div>
	<script>
  const selectedUserId = document.getElementById("selectedUserId");
  // ê¸°ì¡´ JS ìœ ì§€
</script>
</body>
</html>
<script>
  function showUserSection() {
	  showSection('userSection');
	  fetchUsers();
	}
  function showSection(id) {
      document.querySelectorAll(".section-content").forEach(el => el.classList.remove("active"));
      document.getElementById(id).classList.add("active");
    }

    function fetchUsers() {
      fetch("/admin/users")
        .then(res => res.json())
        .then(users => {
          const tbody = document.getElementById("userTableBody");
          if (users.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>íšŒì› ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>";
            return;
          }
          tbody.innerHTML = users.map(user => `
            <tr>
              <td><a href="#" onclick="fetchPayInfo('${user.id}')">${user.id}</a></td>
              <td>${user.name}</td>
              <td>${user.phone}</td>
              <td>${user.userpoint}</td>
              <td>${new Date(user.joinedat).toLocaleDateString()}</td>
            </tr>
          `).join('');
        });
    }

    function filterByLicense(name) {
      document.querySelectorAll("#questionTable tbody tr").forEach(row => {
        row.style.display = (name === 'ì „ì²´' || row.cells[0].textContent === name) ? '' : 'none';
      });
    }

    function fetchPayInfo(id) {
      showSection('payInfoSection');
      document.getElementById("selectedUserId").innerText = id;
      fetch(`/admin/pay-info?userId=${id}`)
        .then(r => r.json())
        .then(data => {
            const html = data.length
              ? data.map(i => `<tr><td>${i.liName} (${i.planType?'í•„ìˆ˜í˜•':'íƒêµ¬í˜•'})</td><td>${i.planStd}</td><td>${Number(i.planPrice).toLocaleString()}ì›</td></tr>`).join('')
              : '<tr><td colspan="3">ê²°ì œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            document.getElementById("payInfoBody").innerHTML = html;
        });
    }

    // ì˜¤ë‹µë¥  í˜ì´ì§• + í•„í„°
    let wrongChart, wrongPage = 0, wrongTotalPages = 1, wrongCurrLicense = 'ì „ì²´';
    function fetchWrongRatePage(page=0, lic=wrongCurrLicense) {
      fetch(`/admin/wrong-rate-page?page=${page}&license=${lic}`)
      .then(r => r.json()).then(res => {
        wrongPage = page; wrongTotalPages = res.totalPages;
        if(wrongChart) wrongChart.destroy();
        wrongChart = new Chart(document.getElementById("wrongRateChart"), {
          type:'bar',
          data:{labels: res.data.map(i=>"ì£¼ì œ "+i.topic), datasets:[{label:'ì˜¤ë‹µë¥ (%)',data:res.data.map(i=>i.rate),backgroundColor:'rgba(255,99,132,0.5)'}]},
          options:{scales:{y:{beginAtZero:true, max:100}}}
        });
        document.getElementById("pageNum").innerText = `${wrongPage+1}`;
        document.getElementById("totalPages").innerText = wrongTotalPages;
      });
    }
    function nextPage(){ if(wrongPage<wrongTotalPages-1) fetchWrongRatePage(wrongPage+1); }
    function prevPage(){ if(wrongPage>0) fetchWrongRatePage(wrongPage-1); }
    function filterWrongByLicense(name){ wrongCurrLicense=name; fetchWrongRatePage(0,name); }

    let refundChart, refundPage = 0, refundTotalPages = 1, refundCurrLicense = 'ì „ì²´';

    function fetchRefundPage(page = 0, lic = refundCurrLicense) {
      fetch(`/admin/refund-rate-page?page=${page}&license=${lic}`)
        .then(r => r.json())
        .then(res => {
          refundPage = page;
          refundTotalPages = res.totalPages;

          const wrapper = document.getElementById("refundChartWrapper");
          const msg = document.getElementById("noRefundDataMsg");

          if (res.data.length === 0) {
            wrapper.style.display = "none";
            msg.style.display = "block";
            document.getElementById("refundTotalPages").style.display = "none";
            return;
          }

          msg.style.display = "none";
          wrapper.style.display = "block";
          document.getElementById("refundTotalPages").style.display = "inline";

          if (refundChart) refundChart.destroy();
          refundChart = new Chart(document.getElementById("refundRateChart"), {
            type: 'bar',
            data: {
              labels: res.data.map(i => i.topic),
              datasets: [{
                label: 'í™˜ê¸‰ë¥ (%)',
                data: res.data.map(i => i.rate),
                backgroundColor: 'rgba(54,162,235,0.5)'
              }]
            },
            options: {
              scales: { y: { beginAtZero: true, max: 100 } }
            }
          });

          document.getElementById("refundPageNum").innerText = `${refundPage + 1}`;
          document.getElementById("refundTotalPages").innerText = refundTotalPages;
        });
    }

    function filterRefundByLicense(name) {
      refundCurrLicense = name;
      fetchRefundPage(0, name);
    }

    function nextRefundPage() { if (refundPage < refundTotalPages - 1) fetchRefundPage(refundPage + 1); }
    function prevRefundPage() { if (refundPage > 0) fetchRefundPage(refundPage - 1); }

    function loadPlanUsage(licenseName) {
    	  fetch(`/admin/plan-usage?licenseName=${licenseName}`)
    	    .then(r => r.json())
    	    .then(data => {
    	      const tbody = document.querySelector("#planUsageTable tbody");
    	      tbody.innerHTML = data.length ? data.map(row => `
    	        <tr>
    	          <td>${row.planType}</td>
    	          <td>${row.userCount}</td>
    	          <td>${row.ratio ?? 0}%</td>
    	          <td>${row.refundRate ?? 0}%</td>
    	        </tr>`).join('') : '<tr><td colspan="4">ë°ì´í„° ì—†ìŒ</td></tr>';
    	    });
    	}
    function goToAllRefundRequests() {
        location.href = "/admin/refund-session";  // <-- ë³€ê²½
    }
    function approveRefund(rfIdx) {
    	  if (!confirm("ì´ í™˜ê¸‰ ìš”ì²­ì„ ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    	  const token = document.querySelector('meta[name="_csrf"]').getAttribute('content');
    	  const header = document.querySelector('meta[name="_csrf_header"]').getAttribute('content');

    	  fetch(`/admin/approve-refund?rfIdx=${rfIdx}`, {
    	    method: 'POST',
    	    headers: {
    	      [header]: token,
    	      'Content-Type': 'application/x-www-form-urlencoded'
    	    }
    	  })
    	  .then(res => {
    	    if (res.ok) {
    	      alert("í™˜ê¸‰ì´ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
    	      location.reload();
    	    } else {
    	      alert("ìŠ¹ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    	    }
    	  });
    	}
    // ì´ˆê¸° ë¡œë“œ
    
    window.onload = () => {
  const params = new URLSearchParams(location.search);
  const section = params.get("section");
  if (section === "refund") {
    showSection('refundRequestSection'); // âœ… ì´ê±¸ ìë™ ì‹¤í–‰í•´ì•¼ í•¨
  }
};
      
   
  </script>
</body>
</html>
