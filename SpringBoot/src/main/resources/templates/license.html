<!DOCTYPE html>
<html lang="ko" xmlns:th="https://www.thymeleaf.org/">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>LICENSE</title>

<!-- Bootstrap & Icons -->
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
	rel="stylesheet">
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.1/jquery.min.js"></script>
<!-- Main Style -->
<link href="/css/style.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* âœ… container ê°•ì œ í†µì¼ */
.container {
	max-width: 1440px !important;
	width: 100%;
	margin-left: auto;
	margin-right: auto;
	padding-left: 12px;
	padding-right: 12px;
	box-sizing: border-box;
}
</style>
</head>

<body>

	<!-- Header -->
	<input type="hidden" id="id" th:if="${member != null}"
		th:value="${member.id}" />

	<nav class="custom-header">
		<div
			class="container d-flex justify-content-between align-items-center">
			<div class="logo d-flex align-items-center gap-2">
				<a href="/"> <img src="/images/ë¡œê³ .png" height="40" alt="ë¡œê³ ">
					<span class="logo-text"></span>
				</a>
			</div>
			<div class="header-links d-flex gap-2">
				<a href="mypage" class="btn btn-outline-secondary">MYPAGE</a> <a
					href="logout" class="btn btn-outline-danger">LOGOUT</a>
			</div>
		</div>
	</nav>

	<!-- Main -->
	<div class="container my-5">
		<div class="content-area">
			<h4 class="text-center mb-5" th:if="${member != null}"
				th:text="${member.name} + 'ë‹˜ ì‹œí—˜ê¹Œì§€ ~ì¼ ë‚¨ì•˜ìŠµë‹ˆë‹¤.'"></h4>

			<div class="row mb-4">
				<!-- Left Column -->
				<div class="col-md-8 d-flex flex-column gap-2" style="height: 100%;">

					<!-- ì‹œí—˜ í’€ê¸° -->
					<div class="dashboard-card">
						<h5 class="fw-bold mb-4">ì‹œí—˜ í’€ê¸°</h5>
						<form method="post" action="/goTest.do"
							class="d-flex align-items-center gap-2 mb-3">
							<div class="flex-grow-1" style="width: 300px; padding-left: 5px;">
								<input type="hidden" th:name="${_csrf.parameterName}"
									th:value="${_csrf.token}" /> <input type="hidden" name="liIdx"
									th:value="${licenseList[0].liIdx}" /> <input type="hidden"
									name="liName" th:value="${licenseList[0].liName}" /> <input
									type="hidden" name="liTime" th:value="${licenseList[0].liTime}" />
								<input type="hidden" name="liPbc"
									th:value="${licenseList[0].liPbc}" /> <select name="category"
									class="form-control rounded-pill px-4 py-2">
									<option value="" disabled selected hidden>íšŒì°¨ ê²€ìƒ‰</option>
									<option value="0">ëœë¤ ë¬¸ì œ</option>
									<th:block th:each="round : ${rounds}">
										<option th:value="${round[2]}"
											th:text="${round[0] + 'ë…„ ' + round[1] + 'íšŒ'}"></option>
									</th:block>
								</select>
							</div>
							<button class="btn btn-light" type="submit"
								style="width: 60px; height: 42px;"
								onclick="if(document.getElementById('category').value == ''){ alert('ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return false; }">ì‹œí—˜</button>
						</form>
					</div>

					<!-- ê¸°ì¶œ í’€ê¸° -->
					<div class="dashboard-card">
						<h5 class="fw-bold mb-4">ê¸°ì¶œ í’€ê¸°</h5>
						<form method="post" action="goExam.do"
							class="d-flex align-items-center gap-2 mb-3">
							<div class="flex-grow-1" style="width: 300px; padding-left: 5px;">
								<input type="hidden" th:name="${_csrf.parameterName}"
									th:value="${_csrf.token}" /> <input type="hidden" name="liIdx"
									th:value="${licenseList[0].liIdx}" /> <input type="hidden"
									name="liName" th:value="${licenseList[0].liName}" /> <input
									type="hidden" name="liTime" th:value="${licenseList[0].liTime}" />
								<input type="hidden" name="liPbc"
									th:value="${licenseList[0].liPbc}" /> <input type="hidden"
									name="liChap1" th:value="${licenseList[0].liChap1}" /> <input
									type="hidden" name="liChap2"
									th:value="${licenseList[0].liChap2}" /> <input type="hidden"
									name="liChap3" th:value="${licenseList[0].liChap3}" /> <input
									type="hidden" name="liChap4"
									th:value="${licenseList[0].liChap4}" /> <input type="hidden"
									name="liChap5" th:value="${licenseList[0].liChap5}" /> <select
									id="category" name="category"
									class="form-control rounded-pill px-4 py-2">
									<option value="default" disabled selected hidden>íšŒì°¨ ê²€ìƒ‰</option>
									<th:block th:each="round : ${rounds}">
										<option th:value="${round[2]}"
											th:text="${round[0] + 'ë…„ ' + round[1] + 'íšŒ'}"></option>
								</select>
							</div>
							<button class="btn btn-light" type="submit"
								style="width: 60px; height: 42px;"
								onclick="if(document.getElementById('category').value == 'default'){ alert('ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return false; }">ì—°ìŠµ</button>
						</form>
					</div>

					<!-- ì£¼ì œë³„ í•™ìŠµí•˜ê¸° -->
					<div class="dashboard-card">
						<h5 class="fw-bold mb-4">ì£¼ì œë³„ í•™ìŠµí•˜ê¸°</h5>
						<form action="/goTopic.do" method="post"
							class="d-flex align-items-center gap-2 mb-3"
							style="padding-left: 5px;">
							<input type="hidden" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}" /> <select id="category"
								name="category" class="form-control rounded-pill px-4 py-2">
								<div id="topicSelect"></div>

							</select>

							<button class="btn btn-light" type="submit"
								style="width: 60px; height: 42px;"
								onclick="if(document.getElementById('category').value == ''){ alert('ìœ í˜•ì„ ì„ íƒí•´ì£¼ì„¸ìš”.'); return false; }">
								<i class="bi bi-search"></i>
							</button>
						</form>
					</div>

				</div>

				<!-- Right Column -->
				<div class="col-md-4">
					<div class="dashboard-card p-4" style="height: 100%;">
						<h5 class="fw-bold mb-3" th:if="${member != null}"
							th:text="${member.name} + 'ë‹˜ì˜ ì£¼ì œë³„ ì˜¤ë‹µ TOP 5'">ì™€ì•„ë¼ë„</h5>
						<!--           	<div th:each="pbIdxList : ${pbIdxList}">
          		<div th:text="${pbIdxList}"></div>
          	</div> -->

						<form action="/updateTopicNums.do" method="post"
							style="display: inline;">
							<input type="hidden" th:name="${_csrf.parameterName}"
								th:value="${_csrf.token}" />
						</form>
						<canvas id="wrongChart" style="width: 100%; height: 100%;"></canvas>
					</div>
				</div>
			</div>
		</div>

		<!-- Calendar & Schedule -->
			<div class="row">
				<div class="col-md-8 mb-4">
					<div class="calendar-box" style="height: 470px;">
						
						<h4 class="d-flex justify-content-between align-items-center mb-3">
						<span style="margin-left: 28px;">
							<button class="btn btn-outline-secondary btn-sm me-2"
								onclick="changeMonth(-1)">â†</button>
							<span id="month-year" style="margin-right: 8px;"></span>
							<button class="btn btn-outline-secondary btn-sm me-2"
								onclick="changeMonth(1)">â†’</button>
						</span>
							<button class="btn" type="button"
								id="check-attendance" style="background-color: #5C9EFF; color: white;  margin-right: 25px">ì¶œì„</button>

						</h4>
						<table>
							<thead>
								<tr>
									<th style="color: red;">ì¼</th>
									<th>ì›”</th>
									<th>í™”</th>
									<th>ìˆ˜</th>
									<th>ëª©</th>
									<th>ê¸ˆ</th>
									<th>í† </th>
								</tr>
							</thead>
							<tbody id="calendar-body"></tbody>

						</table>
					</div>
				</div>
				<div class="col-md-4">
					<div class="card schedule-card" style="height: 470px;">
						<!-- íƒ­ ë©”ë‰´ -->
						<div>
							<div class="tab-menu mb-3">
								<button class="active" onclick="showTab(event, 'apply')">ì ‘ìˆ˜</button>
								<button onclick="showTab(event, 'exam')">ì‹œí—˜</button>
								<button onclick="showTab(event, 'result')">ê²°ê³¼ë°œí‘œ</button>
							</div>
						</div>

						<!-- íƒ­ ì½˜í…ì¸  -->
						<div class="card-body" style="height: 380px; overflow-y: auto;">

							<!-- ì ‘ìˆ˜ íƒ­ -->
							<div id="apply" class="tab-content">
								<div class="exam-item" th:each="exam : ${exams}">
									<div th:each="license : ${licenseList}">
										<h5>
											<span class="exam-title" th:text="${license.liName}">ADP</span>
										</h5>
									</div>
									<div class="exam-date">
										<span
											th:text="${#temporals.format(exam.appStd, 'yyyy-MM-dd (E)')}">2025-07-07</span>
										~ <span
											th:text="${#temporals.format(exam.appEd, 'yyyy-MM-dd (E)')}">2025-07-11</span>
									</div>

								</div>
							</div>

							<!-- ì‹œí—˜ íƒ­ -->
							<div id="exam" class="tab-content" style="display: none;">
								<div class="exam-item" th:each="exam : ${exams}">
									<div th:each="license : ${licenseList}">
										<h5>
											<span class="exam-title" th:text="${license.liName}">ADP</span>
										</h5>
									</div>
									<div class="exam-date">
										<span
											th:text="${#temporals.format(exam.exStd, 'yyyy-MM-dd (E)')}">2025-07-07</span>
										~ <span
											th:text="${#temporals.format(exam.exEd, 'yyyy-MM-dd (E)')}">2025-07-11</span>
									</div>
								</div>
							</div>


							<!-- ê²°ê³¼ë°œí‘œ íƒ­ -->
							<div id="result" class="tab-content" style="display: none;">
								<div class="exam-item" th:each="exam : ${exams}">
									<div th:each="license : ${licenseList}">
										<h5>
											<span class="exam-title" th:text="${license.liName}">ADP</span>
										</h5>
									</div>
									<div class="exam-date">
										<span
											th:text="${#temporals.format(exam.exRd, 'yyyy-MM-dd (E)')}">2025-07-07</span>
									</div>
								</div>
							</div>

						</div>
					</div>
				</div>

				<!-- Footer -->
				<footer class="footer mt-5 py-4 border-top">
					<div class="container text-center">
						<nav class="nav justify-content-center mb-3">
							<a href="#" class="footer-link">Home</a> <a href="#"
								class="footer-link">About</a> <a href="#" class="footer-link">Contact</a>
						</nav>
						<p class="text-muted small mb-0">Â© 2025 ë¬¸ì œ Issue!</p>
					</div>
				</footer>


				<!-- Script -->
<script th:inline="javascript">
				  function syncRightCardHeight() {
					    const leftCol = document.querySelector(".col-md-8");
					    const rightCard = document.querySelector(".col-md-4 .dashboard-card");
					    if (leftCol && rightCard) {
					      rightCard.style.height = leftCol.offsetHeight + "px";
					    }
					  }

					  $(document).ready(function () {
					    loadTopic();
					    syncRightCardHeight();
					  });

					  window.addEventListener("resize", syncRightCardHeight);
   /* ì‹œí—˜ ì¼ì • ë°•ìŠ¤ */
   // showTab í•¨ìˆ˜ì—ì„œ event ì¸ìë¥¼ ë°›ì•„ì„œ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
  function showTab(event, tabId) {
    // íƒ­ ì»¨í…ì¸  ì „ë¶€ ìˆ¨ê¹€
    document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
    // ì„ íƒí•œ íƒ­ë§Œ í‘œì‹œ
    document.getElementById(tabId).style.display = 'block';

    // íƒ­ ë©”ë‰´ í™œì„±í™” í‘œì‹œ
    document.querySelectorAll('.tab-menu button').forEach(btn => btn.classList.remove('active'));
    event.currentTarget.classList.add('active');
  }
 function loadTopic() {
    
       // ë¦¬ìŠ¤íŠ¸ë¼ì„œ.. ì´ë ‡ê²Œ ê°€ì ¸ì˜´
       let topicList = /*[[${topicList}]]*/ [];

      const Name = [];

       listHtml = "";
       listHtml = "<option value='' disabled selected hidden>ìœ í˜• ì„ íƒ</option>";
       
       for (let i = 0; i < topicList.length; i++) {
            let parts = topicList[i].topicName.split(" - ");
            Name.push(parts[0]);
          }
       
       for(let i=0; i<topicList.length; i++){
                   
          listHtml += "<option value='" + topicList[i].topicIdx + "'>"+ topicList[i].topicNum+". " + Name[i] + "</option>";


       }
       $("#topicSelect").html(listHtml);   
       
 } 
  const examPeriods = /*[[${exams}]]*/ [];
  const examDates = [];

  examPeriods.forEach(exam => {
    const start = new Date(exam.appStd);
    const end = new Date(exam.appEd);
    let d = new Date(start);
    while (d <= end) {
    const dateStr = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')}`;
      examDates.push({ date: dateStr, title: exam.title });
      d.setDate(d.getDate() + 1);
    }
  });

  // calendarBody: ë‹¬ë ¥ í…Œì´ë¸”(<tbody>)ì„ ë„£ì„ ìœ„ì¹˜
  const calendarBody = document.getElementById("calendar-body");
  
  // monthYear: "2025ë…„ 6ì›”" ë“± ë‹¬ë ¥ ìƒë‹¨ íƒ€ì´í‹€
  const monthYear = document.getElementById("month-year");
    
  const checkAttendanceBtn = document.getElementById("check-attendance");
    
  // currentDate: í˜„ì¬ ê¸°ì¤€ ë‹¬ë ¥ ë‚ ì§œ
  let currentDate = new Date();
  
  // attendanceDates: ì¶œì„ì²´í¬ ëœ ë‚ ì§œë“¤ (ë‚˜ì¤‘ì— ì„œë²„ì—ì„œ ë°›ì•„ì˜¬ ìˆ˜ë„ ìˆìŒ)
  let attendanceDates = JSON.parse('[[${date}]]'); // ì¶œì„í•œ ë‚ ì§œ ì €ì¥ìš© ë°°ì—´
  renderCalendar(currentDate);  // í˜ì´ì§€ ë¡œë“œì‹œ ë‹¬ë ¥ ë Œë”ë§
  
  // ë‚ ì§œ í•¨ìˆ˜ 2ìë¦¬ ìˆ˜ë¡œ ë³€ê²½ ex 2025-6-6 -> 2025-06-06
  function pad(n) {
     return n < 10 ? "0" + n : n;
   }

  // ë‹¬ë ¥ì„ ë Œë”ë§í•˜ëŠ” í•¨ìˆ˜
  function renderCalendar(date) {
    calendarBody.innerHTML = ""; // ê¸°ì¡´ ë‹¬ë ¥ ì´ˆê¸°í™”
    const year = date.getFullYear();
    const month = date.getMonth();
    const firstDay = new Date(year, month, 1).getDay(); // 1ì¼ì˜ ìš”ì¼ (0=ì¼, 6=í† )
    const lastDate = new Date(year, month + 1, 0).getDate(); // ì›”ì˜ ë§ˆì§€ë§‰ ì¼
    const today = new Date();

    monthYear.textContent = `ğŸ“… ${year}ë…„ ${month + 1}ì›”`;

    // 6ì£¼ Ã— 7ì¼ ë‹¬ë ¥ ë§Œë“¤ê¸° ( í•œ ë‹¬ì€ ìµœëŒ€ 6ì£¼ê¹Œì§€ ìˆì–´ì„œ )
    let day = 1;
    for (let i = 0; i < 6; i++) {
      const row = document.createElement("tr");
      for (let j = 0; j < 7; j++) {
        const cell = document.createElement("td");

        
        // ì²« ì£¼(i==0)ì—ì„œ firstDay ì´ì „ì—ëŠ” ë¹ˆì¹¸
        // day > lastDateë©´ ì›”ì´ ëë‚¬ìœ¼ë¯€ë¡œ ë¹ˆì¹¸
        if (i === 0 && j < firstDay || day > lastDate) {
          cell.innerHTML = "";
        } else {
          const thisDate = new Date(year, month, day);
          const dateStr = `${year}-${pad(month + 1)}-${pad(day)}`;

          const dayCircle = document.createElement("div");
          dayCircle.classList.add("day-circle");
          dayCircle.textContent = day;

            // ì˜¤ëŠ˜ ë‚ ì§œ í‘œì‹œ
          if (today.getFullYear() === year && today.getMonth() === month && today.getDate() === day) {
            dayCircle.classList.add("today");
          }

          // ì¼ìš”ì¼ ìŠ¤íƒ€ì¼
          if (j === 0) {
            cell.classList.add("sunday");
          }

          // ì¶œì„í•œ ë‚ ì§œ(dateStr)ëŠ” í‘œì‹œ
          if (attendanceDates.includes(dateStr)) {
            dayCircle.classList.add("attended");
          }
          /* ë‹¬ë ¥ì— ì¼ì • í‘œì‹œ */
          const exam = examDates.find(e => e.date === dateStr);
         if (exam ) {
           dayCircle.classList.add("exam-period-bar");
           dayCircle.setAttribute("data-title", exam.title);
         }

          // í˜„ì¬ ì…€ì— í•´ë‹¹ ë‚ ì§œë¥¼ ì‹œê°ì ìœ¼ë¡œ ë³´ì—¬ì¤„ div.day-circleì„ ì‚½ì…í•˜ëŠ” ì—­í• 
          cell.appendChild(dayCircle);
          day++;
        }

        // í˜„ì¬ tr ì¤„ì— td í•˜ë‚˜ë¥¼ ì¶”ê°€
        row.appendChild(cell);
      }
      calendarBody.appendChild(row);
      if (day > lastDate) break; // ë‹¤ ì±„ìš°ë©´ ë£¨í”„ íƒˆì¶œ
    }
  }

  
  function changeMonth(step) {
    currentDate.setMonth(currentDate.getMonth() + step);
    renderCalendar(currentDate);
    
  }

  checkAttendanceBtn.addEventListener("click", () => {
     const id = $("#id").val();

     $.ajax({
       url: "/atd_check",
       type: "post",
       dataType: "text",
       data: { id: id },
       success: function (response) {
         if (response === "true") { // ì‘ë‹µì´ Trueì¼ ê²½ìš°
           alert("ì¶œì„ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");

           // ì—¬ê¸°ì„œë¶€í„° elseì „ê¹Œì§€ ì „ë¶€ ë™ê·¸ë¼ë¯¸ í‘œì‹œ ì˜ì—­
           const today = new Date();
           console.log(today);
           // ë…„,ì›”,ì¼ ë¬¸ìì—´ í‘œì‹œ - ex) "2025-06-06" / MonthëŠ” 0ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ +1
           const dateStr = `${today.getFullYear()}-${pad(today.getMonth() + 1)}-${pad(today.getDate())}`;
           if (!attendanceDates.includes(dateStr)) {
             attendanceDates.push(dateStr);
           }

           renderCalendar(currentDate); // ë‹¤ì‹œ ë Œë”ë§
         } else {
           alert("ì´ë¯¸ ì¶œì„í•˜ì…¨ìŠµë‹ˆë‹¤!");
           
         }
       },
       error: function () {
         alert("ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
       }
     });
   });
   


  renderCalendar(currentDate);

</script>
</body>

</html>